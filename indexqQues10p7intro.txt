<!--
====================================================================
CONFIGURATION RAPIDE (Ã  modifier en haut du fichier)

- homeHeaderDefaultByLang : texte court dans la banderole AVANT le choix
  (ex. 'Bienvenue' / 'Welcome' / 'VÃ¤lkommen' OU 'Questionnaire' / 'FrÃ¥geformulÃ¤r')
- homeHeaderIntroLinesByLang : 2 lignes dâ€™intro affichÃ©es dans la banderole (accueil)
- availableLangsByForm : langues disponibles par ID de questionnaire (empÃªche "Continuer" si non dispo)
- disabledForms : IDs des questionnaires pas encore prÃªts (seront affichÃ©s "(indisponible)")
- formLabelsByLang : libellÃ©s des questionnaires dans la liste (si votre code ne les dÃ©finit pas dÃ©jÃ )
- introByFormOverrides : texte dâ€™intro (page 2) spÃ©cifique par formulaire et langue (Ã©crase le gÃ©nÃ©rique)
- messagesInterfaceOverrides : petites clÃ©s i18n Ã  surcharger (ex. notAvailableLang, only)
- APP_VERSION_OVERRIDE : pour forcer la version affichÃ©e sans Ã©diter APP.version plus bas (optionnel)

- Il existe deux banques de questions :
    1. questionsBank : version complÃ¨te, utilisÃ©e en routine (DSM, Sommeil, etc.).
    2. questionsBankShort (ou Intro) : version rÃ©duite, utilisÃ©e uniquement pour des tests ou des dÃ©monstrations.
   Le programme charge lâ€™une ou lâ€™autre en fonction du mode choisi (standard vs test).

COMMENT MODIFIER :
- Changez simplement les valeurs dans les objets JS ci-dessous (entre <script>â€¦</script>).
- Laissez les clÃ©s telles quelles (FranÃ§ais/English/Svenska, DSM/SOMMEIL/etc.).

====================================================================
-->
ï»¿<!DOCTYPE html>
<html lang="fr">
<head>
<style>
#introText { white-space: pre-line; line-height: 1.9 !important; }
#labelCode { font-weight: 700; }
</style>

  <!-- ========== CONFIG ACCUEIL & I18N (Ã©diter ici) ========== -->
  <script>
    // Titre court dans la banderole AVANT le choix
    window.homeHeaderDefaultByLang = {
      'FranÃ§ais': 'Questionnaire',
      'English':  'Questionnaire',
      'Svenska':  'FrÃ¥geformulÃ¤r'
    };

    // 2 lignes dâ€™intro dans la banderole (accueil)
    window.homeHeaderIntroLinesByLang = {
      'FranÃ§ais': [
        'Choisissez un questionnaire et une langue pour commencer.',
        'Vos rÃ©ponses sont confidentielles. Prenez votre temps.'
      ],
      'English': [
        'Pick a questionnaire and a language to get started.',
        'Your answers are confidential. Take your time.'
      ],
      'Svenska': [
        'VÃ¤lj formulÃ¤r och sprÃ¥k fÃ¶r att bÃ¶rja.',
        'Dina svar Ã¤r konfidentiella. Ta den tid du behÃ¶ver.'
      ]
    };

  <script>
// Langues disponibles par questionnaire (ID = value du <select>)
window.availableLangsByForm = {
  DSM:      ['FranÃ§ais','English','Svenska'],
  Sommeil:  ['FranÃ§ais','English','Svenska'],
  Psych:    ['FranÃ§ais','English','Svenska'],
  Neurology:['FranÃ§ais','English','Svenska'],
  MedGle:   ['FranÃ§ais','English','Svenska']
};

// (optionnel) Questionnaires temporairement indisponibles
window.disabledForms = window.disabledForms || [];

// LibellÃ©s des questionnaires dans la liste
// âš ï¸ Les clÃ©s doivent correspondre aux values rÃ©elles du <select> : DSM, Sommeil, Psych, Neurology, MedGle
window.formLabelsByLang = {
  'FranÃ§ais': { DSM:'DSM-5', Sommeil:'Sommeil', Psych:'Psych', Neurology:'Neurologie', MedGle:'MÃ©decine gÃ©nÃ©rale' },
  'English' : { DSM:'DSM-5', Sommeil:'Sleep',   Psych:'Psych', Neurology:'Neurology',  MedGle:'General Medicine' },
  'Svenska' : { DSM:'DSM-5', Sommeil:'SÃ¶mn',    Psych:'Psykiatri', Neurology:'Neurologi', MedGle:'AllmÃ¤nmedicin' }
};
</script>

<script>
// Intro (page 2) spÃ©cifique par formulaire (facultatif : Ã©crase le texte gÃ©nÃ©rique)
    window.introByFormOverrides = window.introByFormOverrides || {
      'FranÃ§ais': {
        // DSM: "Ce questionnaire aide Ã  repÃ©rer des symptÃ´mes selon le DSM-5...",
        // SOMMEIL: "Ce module Ã©value la qualitÃ© et lâ€™hygiÃ¨ne du sommeil..."
      },
      'English': {
        // DSM: "This DSM-5 screening helps you spot symptoms...",
        // SOMMEIL: "This sleep module assesses sleep quality and habits..."
      },
      'Svenska': {
        // DSM: "DSM-5-screening hjÃ¤lper dig att identifiera symtom...",
        // SOMMEIL: "Denna sÃ¶mnmodul bedÃ¶mer sÃ¶mnkvalitet och vanor..."
      }
    };

    // Petites clÃ©s i18n Ã  surcharger si besoin (messagesInterface)
    window.messagesInterfaceOverrides = window.messagesInterfaceOverrides || {
      'FranÃ§ais': { notAvailableLang: 'Non disponible dans cette langue', only: 'seulement' },
      'English':  { notAvailableLang: 'Not available in this language',   only: 'only' },
      'Svenska':  { notAvailableLang: 'Inte tillgÃ¤ngligt pÃ¥ detta sprÃ¥k', only: 'endast' }
    };

    // Option : forcer la version affichÃ©e sans modifier APP.version (laisser "" pour ne rien faire)
    window.APP_VERSION_OVERRIDE = window.APP_VERSION_OVERRIDE || "";
</script>
  <!-- ========== /CONFIG ========== -->

  <!-- ========== BANQUE DE QUESTIONS (multi-formulaires) ========== -->
  <script>
    /* Remplacez ces tableaux par vos questions rÃ©elles.
       Laissez les clÃ©s (DSM, SOMMEIL, NEUROLOGIE, PSYCHIATRIE, MEDEG) et les langues. */
    window.QUESTIONNAIRE_BANK = {
      DSM: {
        FranÃ§ais: [
          { section: 1, skipIfNon: true, text: "Avez-vous eu rÃ©cemment des pÃ©riodes de tristesse ? (Si non, passer Ã  la section suivante)" },
          { id:"DSM_FR_Q1", type:"oui-non", texte:"Ces deux derniÃ¨res semaines, vous Ãªtes-vous senti(e) dÃ©primÃ©(e) ?" },
          { id:"DSM_FR_Q2", type:"texte",   texte:"Pouvez-vous prÃ©ciser ?" }
        ],
        English: [
          { section: 1, skipIfNon: true, text: "Have you recently had periods of sadness? (If no, skip to next section)" },
          { id:"DSM_EN_Q1", type:"oui-non", texte:"In the last two weeks, have you felt depressed?" },
          { id:"DSM_EN_Q2", type:"texte",   texte:"Please specify." }
        ],
        Svenska: [
          { section: 1, skipIfNon: true, text: "Har du nyligen haft perioder av nedstÃ¤mdhet? (Om nej, gÃ¥ vidare)" },
          { id:"DSM_SV_Q1", type:"oui-non", texte:"Har du kÃ¤nt dig deprimerad de senaste tvÃ¥ veckorna?" },
          { id:"DSM_SV_Q2", type:"texte",   texte:"FÃ¶rklara gÃ¤rna." }
        ]
      },
      SOMMEIL: {
        FranÃ§ais: [
          { section: 1, skipIfNon: true, text: "Avez-vous des difficultÃ©s dâ€™endormissement ? (Si non, passer Ã  la section suivante)" },
          { id:"SOM_FR_Q1", type:"oui-non", texte:"Avez-vous des difficultÃ©s Ã  vous endormir ?" },
          { id:"SOM_FR_Q2", type:"texte",   texte:"Ã€ quelle frÃ©quence ?" }
        ],
        English: [
          { section: 1, skipIfNon: true, text: "Do you have trouble falling asleep? (If no, skip to next section)" },
          { id:"SOM_EN_Q1", type:"oui-non", texte:"Do you have difficulty falling asleep?" },
          { id:"SOM_EN_Q2", type:"texte",   texte:"How often?" }
        ],
        Svenska: [
          { section: 1, skipIfNon: true, text: "Har du svÃ¥rt att somna? (Om nej, gÃ¥ vidare)" },
          { id:"SOM_SV_Q1", type:"oui-non", texte:"Har du svÃ¥rt att somna?" },
          { id:"SOM_SV_Q2", type:"texte",   texte:"Hur ofta?" }
        ]
      },
      NEUROLOGIE: {
        FranÃ§ais: [
          { section: 1, skipIfNon: true, text: "Avez-vous eu des maux de tÃªte rÃ©cents ? (Si non, section suivante)" },
          { id:"NEURO_FR_Q1", type:"oui-non", texte:"Maux de tÃªte frÃ©quents ?" },
          { id:"NEURO_FR_Q2", type:"texte",   texte:"PrÃ©cisez la frÃ©quence." }
        ],
        English:  [
          { section: 1, skipIfNon: true, text: "Any recent headaches? (If no, next section)" },
          { id:"NEURO_EN_Q1", type:"oui-non", texte:"Frequent headaches?" },
          { id:"NEURO_EN_Q2", type:"texte",   texte:"How often?" }
        ],
        Svenska:  [
          { section: 1, skipIfNon: true, text: "Har du haft huvudvÃ¤rk nyligen? (Om nej, nÃ¤sta avsnitt)" },
          { id:"NEURO_SV_Q1", type:"oui-non", texte:"Ofta huvudvÃ¤rk?" },
          { id:"NEURO_SV_Q2", type:"texte",   texte:"Hur ofta?" }
        ]
      },
      PSYCHIATRIE: {
        FranÃ§ais: [ { section:1, skipIfNon:true, text:"Section psychiatrieâ€¦" } ],
        English:  [ { section:1, skipIfNon:true, text:"Psychiatry sectionâ€¦" } ],
        Svenska:  [ { section:1, skipIfNon:true, text:"Psykiatri avsnittâ€¦" } ]
      },
      MEDEG: {
        FranÃ§ais: [ { section:1, skipIfNon:true, text:"MÃ©decine gÃ©nÃ©raleâ€¦" } ],
        English:  [ { section:1, skipIfNon:true, text:"General medicineâ€¦" } ],
        Svenska:  [ { section:1, skipIfNon:true, text:"AllmÃ¤nmedicinâ€¦" } ]
      }
    };
  </script>
  <!-- ========== /BANQUE DE QUESTIONS ========== -->


  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title id="pageTitle">Questionnaire</title>

  <style>
    body{
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 0;
      color: #333;
    }

    header, footer{
      background-color: #0056cc;
      color: #fff;
      padding: 1em;
      text-align: center;
    }

    section{
      background-color: #fff;
      margin: 1.5em auto;
      padding: 1.5em;
      border-radius: 8px;
      max-width: 900px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    h1, h2{
      color: #0056cc;
      margin-top: 0;
    }

    /* Barre de titre compacte */
    #titleBar{
      display:flex;
      gap:10px;
      justify-content:center;
      align-items:baseline;
      margin:0;
    }
    #versionNum{ font-weight:normal; opacity:.95; }

    /* Instructions */
    .instructions{
      background-color:#ffffcc;
      color:#000;
      font-size:1em;
      padding:10px;
      border-radius:5px;
      margin-bottom:10px;
    }
    .instructions span{ color:#c00; font-weight:bold; }
    #microStatus{ font-weight:bold; margin-left:10px; color:red; }

    .question-number{ font-weight:bold; margin-bottom:5px; }
    .section-number{ color:#0056cc; font-weight:bold; margin-bottom:10px; }

    textarea, input[type="text"], input[type="number"]{
      width:96%;
      font-size:1em;
      padding:8px;
      margin-top:5px;
      border:1px solid #ccc;
      border-radius:4px;
      min-height:40px;
    }

    button{
      background-color:#0056cc;
      color:#fff;
      border:none;
      padding:10px 18px;
      margin:8px 5px;
      border-radius:4px;
      cursor:pointer;
      font-size:1em;
    }
    button:hover{ background-color:#004bb5; }

    .error{ color:red; margin-top:8px; min-height:20px; font-weight:bold; }

    #progressContainer{ background:#ddd; width:100%; height:8px; margin-top:15px; border-radius:5px; }
    #progressBar{ background:#0056cc; height:8px; width:0%; border-radius:5px; }

    #scoreContainer{ display:none; margin-top:10px; }
    #scoreContainer label{ color:red; font-weight:bold; }

    ul{ list-style:none; padding:0; }
    textarea.editable{ width:95%; min-height:50px; margin-top:5px; margin-bottom:15px; border:1px solid #ccc; border-radius:5px; }

    /* Accueil : selects plus petits et lisibles */
    #menuScreen select{
      width:50%;
      max-width:360px;
      font-size:14px;
      padding:4px 8px;
      height:32px;
      background:#fff;
      color:#000;
      border:1px solid #888;
      box-shadow:none;
      appearance:auto;
    }
    #menuScreen label{
      display:inline-block;
      min-width:140px;
      margin-bottom:4px;
    }
  
    /* >>> AJOUT : rendre le texte du header lisible (blanc sur bandeau bleu) <<< */
    header h1, header #titleBar, header #titleBar span {
      color: #fff !important;
    }

    /* >>> AJOUT : rendre le texte du header lisible (blanc sur bandeau bleu) <<< */
    header h1, header #titleBar, header #titleBar span { color: #fff !important; }

    /* Intro d'accueil (bandeau bleu) */
    .header-intro{
      margin:.25em auto 0;
      max-width:900px;
      font-size:.95em;
      line-height:1.35;
      opacity:.95;
    }
    header .header-intro{ color:#fff; }

    /* Intro un peu plus grande dans la banderole */
    header .header-intro{
      font-size: 1.15em;
      line-height: 1.45;
      font-weight: 500;
      opacity: 1;
    }
</style>
</head>

<body>

  <header>
    <h1 id="titleBar">
      <span id="mainTitle">Questionnaire DSM-5</span>
      â€”
      <span id="versionNum">Version Q10p</span>
    </h1>
    <div id="headerIntro" class="header-intro" aria-live="polite" style="display:none"></div>
  </header>


  <!-- ======================================================
       ACCUEIL / INTRO / QUESTIONNAIRE / RÃ‰SUMÃ‰
       ====================================================== -->
  <section id="menuScreen">
    <h2>SÃ©lectionner Questionnaire et Langue</h2>

    <label for="questionnaireSelect">Questionnaire :</label>
    <select id="questionnaireSelect"></select>
    <br><br>

    <label for="langSelect">Langue :</label>
    <select id="langSelect"></select>
    <br><br>

    <div id="menuError" class="error"></div>
    <button id="nextLangBtn">Continuer</button>
  </section>

  <section id="introScreen" style="display:none;">
    <h2>Introduction</h2>

    <p id="introText"></p>

    <label id="labelCode"></label><br>
    <input type="text" id="codeInput" maxlength="4" inputmode="numeric" pattern="[0-9]*" />
    <div id="introErrorMsg" class="error"></div>

    <br>
    <button id="startBtn">Commencer</button>
  </section>

  <section id="main" style="display:none;">
    <div id="instructionBox" class="instructions">
      Au clavier <span>RETOUR</span>, en vocal dire <span>STOP</span>
      <span id="microStatus">ğŸ¤ Micro fermÃ©</span>
    </div>

    <div id="sectionNum" class="section-number"></div>
    <div id="questionNum" class="question-number"></div>

    <div id="questionText"></div>

    <textarea id="answerInput"></textarea>
    <div id="mainErrorMsg" class="error"></div>

    <div id="scoreContainer">
      <label id="scoreLabel">âš ï¸ AprÃ¨s votre rÃ©ponse, entrez un chiffre de 1 Ã  4 : 1=rarement, 2=parfois, 3=souvent, 4=trÃ¨s souvent</label>
      <br>
      <input type="number" id="scoreInput" min="1" max="4" />
      <button id="validateScoreBtn">OK</button>
    </div>

    <div id="progressContainer"><div id="progressBar"></div></div>

    <button id="validerBtn">Valider</button>
    <button id="corrigerBtn">Corriger</button>
    <button id="pauseBtn">Pause</button>
    <button id="voiceBtn" type="button">ğŸ™ï¸ Micro</button>
    <button id="ttsToggleBtn">Vocal</button>
  </section>

  <section id="summary" style="display:none;">
    <h2 id="summaryTitle">RÃ©sumÃ© et correction</h2>
    <p><strong id="summaryCodeLabel">Code questionnaire :</strong> <span id="resumeCode"></span></p>
    <ul id="answersList"></ul>
    <label id="globalCommentLabel" for="globalComment">Commentaires</label>

    <textarea id="globalComment" placeholder="Votre commentaire globalâ€¦"></textarea>
    <br>
    <button id="pdfBtn">Exporter PDF</button>
    <button id="copyBtn">Copier</button>
    <button id="closeBtn">Terminer</button>
    <button id="btnProgramme"></button>
    <button id="btnLanguage"></button>
    
  </section>

  <footer style="text-align:center;font-size:.85em;color:#ddd;margin-top:2em;">
    <p>Â© 2025 SwedSleep - vers 10p</p>
  </footer>


  <!-- ======================================================
       SCRIPT â€“ CONFIG, DONNÃ‰ES, FONCTIONS
       ====================================================== -->
  <script>
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // CONFIG : titre dynamique (nom + version)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const APP = {
    nom: "Questionnaire DSM-5",
    version: "Version Q10p"
  };

  function majTitrePage(nom = APP.nom, version = APP.version){
    try{
      document.getElementById('pageTitle').textContent = version ? (nom + " - " + version) : nom;
    }catch(_){}
  }

  function updateHeaderBar(){
    try{
      document.getElementById("mainTitle").textContent  = APP.nom;
      document.getElementById("versionNum").textContent = APP.version;
    }catch(_){}
    majTitrePage();
  }


  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // DONNÃ‰ES : formulaires, intros, messages, questions
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const disabledForms = ["Sommeil","Psych","Neurology","MedGle"];

  const introByForm = {
    "FranÃ§ais": {
      unavailable: "indisponible",
      DSM: "Ce questionnaire est anonyme.\nJe vais vous poser des questions se rapportant aux 2 derniers mois.\nCes questions sont regroupÃ©es en sections.\nComptez environ 15 min. Vous pouvez faire une pause.\nEn cas dâ€™erreur, vous pouvez corriger.\nRÃ©pondez DE PREFERENCE sur le clavier mais vous pouvez aussi utiliser le micro.\nParlez alors lentement et distinctement, terminez vos rÃ©ponses en disant STOP ou VALIDER.\nÃ€ la fin, vous pourrez corriger vos rÃ©ponses, ajouter un commentaire, copier vos rÃ©ponses ou les enregistrer en PDF grÃ¢ce aux boutons prÃ©vus Ã  cet effet.\nSi vous ne voulez pas entendre les questions pressez la touche VOCAL",
      Sommeil: "Questionnaire Sommeil (FR)â€¦",
      Psych: "Questionnaire Psych (FR)â€¦",
      Neurology: "Questionnaire Neurologie (FR)â€¦",
      MedGle: "Questionnaire MÃ©decine GÃ©nÃ©rale (FR)â€¦",
      comments: "Commentaires"
    },
    "English": {
      unavailable: "unavailable",
      DSM: "This form screens DSM-5 related symptoms. Answer freely. You can pause anytime.",
      Sommeil: "Sleep questionnaire (EN)â€¦",
      Psych: "Psych questionnaire (EN)â€¦",
      Neurology: "Neurology questionnaire (EN)â€¦",
      MedGle: "General Practice questionnaire (EN)â€¦",
      comments: "Comments"
    },
    "Svenska": {
      unavailable: "otillgÃ¤nglig",
      DSM: "Detta formulÃ¤r hjÃ¤lper att identifiera symtom enligt DSM-5. Du kan pausa nÃ¤r som helst.",
      Sommeil: "SÃ¶mnformulÃ¤r (SV)â€¦",
      Psych: "PsykologiformulÃ¤r (SV)â€¦",
      Neurology: "NeurologiformulÃ¤r (SV)â€¦",
      MedGle: "AllmÃ¤nmedicin formulÃ¤r (SV)â€¦",
      comments: "Kommentarer"
    }
  };

  let config = {
    nomQuestionnaire: "Questionnaire DSM-5",
    version: "v Q10p",
    couleursBande: "#ffffcc",
    langues: ["FranÃ§ais","English","Svenska"],
    tempsBaseReponse: 1200,
    tempsParCaractere: 50,
    tempsMaxReponse: 4000
  };

  // QUESTIONS â€“ liste complÃ¨te (sections 1 â†’ 23)
  let questions = [
    { section: 1,  text: "Quel est votre Ã¢ge?" },
    {              text: "Etes vous un homme, une femme ou autre ?" },
    {              text: "Quel est votre profession ?" },

    { section: 2,  text: "Y a-t-il des antÃ©cÃ©dents mÃ©dicaux connus ? Si oui, veuillez prÃ©ciser." },
    {              text: "Des traitements <b>mÃ©dicamenteux</b> sont-ils actuellement suivis ? Si oui, veuillez indiquer lesquels, y compris les mÃ©dicaments sans ordonnance et les complÃ©ments alimentaires." },

    { section: 3,  text: "Ressentez-vous de la nervositÃ©, de lâ€™anxiÃ©tÃ© ou une tension excessive ?" },
    {              text: "Avez-vous tendance Ã  vous inquiÃ©ter excessivement pour diverses choses, ou Ã  ne pas pouvoir contrÃ´ler vos inquiÃ©tudes ?" },
    {              text: "Avez-vous des difficultÃ©s Ã  vous concentrer, par exemple en lisant ou en regardant la tÃ©lÃ©vision ?" },
    {              text: "Vous sentez-vous agitÃ©, avez-vous du mal Ã  rester assis tranquillement ?" },
    {              text: "Observez-vous des troubles de lâ€™appÃ©tit, tels quâ€™une perte ou une augmentation de lâ€™appÃ©tit ?" },
    {              text: "Ressentez-vous un sentiment dâ€™Ã©chec ou dâ€™avoir dÃ©Ã§u vous-mÃªme ou votre entourage ?" },

    { section: 4,  text: "Manquez-vous dâ€™intÃ©rÃªt ou de plaisir Ã  faire des choses qui vous plaisaient auparavant ?" },
    {              text: "Ressentez-vous une tristesse, une humeur dÃ©pressive,ou un sentiment de dÃ©sespoir ?" },
    {              text: "Vous sentez-vous fatiguÃ© ou avez-vous un manque dâ€™Ã©nergie ?" },

    { section: 5,  skipIfNon: true, text: "RÃ©pÃ©tez-vous certains gestes, comme vous laver les mains, compter, vÃ©rifier ou organiser des objets ? (Si non, passage Ã  la section suivante)" },
    {              text: "Ces comportements sont-ils effectuÃ©s en rÃ©ponse Ã  une pensÃ©e obsessionnelle ou une peur ?" },
    {              text: "Ces pensÃ©es ou comportements occupent-ils plus dâ€™une heure par jour ou perturbent-ils significativement votre vie quotidienne ?" },

    { section: 6,  text: "ÃŠtes-vous facilement irritable ou en colÃ¨re ?" },
    {              text: "Estimez-vous que vos accÃ¨s de colÃ¨re sont disproportionnÃ©s par rapport Ã  la situation ?" },

    { section: 7,  text: "Traversez-vous des pÃ©riodes oÃ¹ vous vous sentez particuliÃ¨rement Ã©nergique, euphorique ou surexcitÃ©(e) ?" },
    {              text: "Lors de ces pÃ©riodes, avez-vous tendance Ã  entreprendre des activitÃ©s qui pourraient avoir des consÃ©quences nÃ©gatives ?" },

    { section: 8,  text: "Vous arrive-t-il de vous sentir dÃ©tachÃ© de vous-mÃªme ou de votre environnement ?" },
    {              text: "Avez-vous dÃ©jÃ  ressenti une impression dâ€™irrÃ©alitÃ© Ã  propos de votre environnement ?" },

    { section: 9,  skipIfNon: true,text: "Rencontrez-vous des difficultÃ©s de mÃ©moire rÃ©centes ou plus anciennes, comme oublier des informations ou perdre le sens de lâ€™orientation (par exemple, retrouver votre chemin) ? " },
    {              text: "Dans quelles circonstances ressentez vous ces difficultÃ©s ? " },

    { section: 10, text: "Dans quelle mesure ces difficultÃ©s ont-elles affectÃ© votre capacitÃ© Ã  travailler, Ã  vous occuper de votre domicile ou Ã  entretenir des relations avec autrui ?" },
    {              text: "Ã€ quel point estimez-vous que votre situation de vie actuelle et vos relations sociales vous apportent du soutien ?" },

    { section: 11, text: "Utilisez-vous du tabac, de lâ€™alcool, des drogues ou de la cafÃ©ine ? Si oui, veuillez indiquer la quantitÃ©." },

    { section: 12, text: "Ressentez-vous des douleurs chroniques ou un inconfort physique ? Si oui, merci de prÃ©ciser." },
    {              text: "Y a-t-il dâ€™autres symptÃ´mes physiques que vous avez remarquÃ©s et qui vous prÃ©occupent ?" },
    {              text: "Comment Ã©valueriez-vous votre Ã©tat de santÃ© physique global (mauvais, passable, bon, trÃ¨s bon, excellent) ?" },

    { section: 13, text: "Avez-vous eu des pensÃ©es selon lesquelles il vaudrait mieux Ãªtre mort ou vous blesser dâ€™une quelconque maniÃ¨re ?" },

    { section: 14, text: "Comment Ã©valueriez-vous la qualitÃ© gÃ©nÃ©rale de votre sommeil ?" },
    {              text: "Ã‰prouvez-vous des difficultÃ©s Ã  vous endormir ou Ã  rester endormi durant la nuit ?" },
    {              text: "Vous rÃ©veillez-vous le matin en vous sentant reposÃ© ou encore fatiguÃ© ?" },
    {              text: "Avez-vous des troubles du sommeil, tels que des cauchemars, du somnambulisme ou des rÃ©veils frÃ©quents ?" },
    {              text: "Utilisez-vous des mÃ©dicaments ou des substances pour faciliter le sommeil ? si oui lesquels" },
    {              text: "Des changements de mode de vie ou des Ã©vÃ©nements rÃ©cents ont-ils modifiÃ© votre rythme de sommeil ?" },

    { section: 15, text: "Pratiquez-vous une activitÃ© physique ou de lâ€™exercice ? decrivez si vous le voulez" },

    { section: 16, text: "Un diagnostic de trouble psychique a-t-il dÃ©jÃ  Ã©tÃ© posÃ© auparavant ?" },
    {              text: "Un traitement pour des difficultÃ©s psychiques a-t-il dÃ©jÃ  Ã©tÃ© suivi (thÃ©rapie, conseil, mÃ©dication) ? Si oui, merci de prÃ©ciser." },

    { section: 17, text: "Avez-vous perÃ§u des voix que les autres ne semblent pas entendre ?" },
    {              text: "Avez-vous eu des croyances ou des idÃ©es que dâ€™autres personnes considÃ¨rent comme Ã©tranges ou inhabituelles ?" },

    { section: 18, text: "Vous arrive-t-il de vous inquiÃ©ter de faÃ§on excessive pour votre poids ou votre apparence corporelle ?" },
    {              text: "Avez-vous eu des Ã©pisodes de restriction alimentaire importante, de vomissements volontaires, ou de prises alimentaires excessives et incontrÃ´lables ?" },

    { section: 19, text: "Avez-vous constatÃ© une baisse notable de votre intÃ©rÃªt ou de votre satisfaction concernant votre sexualitÃ© ?" },

    { section: 20, text: "Avez-vous Ã©tÃ© exposÃ© Ã  un Ã©vÃ©nement traumatique qui continue Ã  vous perturber (cauchemars, flashbacks, Ã©vitement) ?" },
    {              text: "PrÃ©sentez-vous des rÃ©actions de stress importantes en lien avec des souvenirs douloureux ?" },

    { section: 21, text: "Rencontrez-vous souvent des difficultÃ©s Ã  rester concentrÃ©, Ã  terminer ce que vous commencez, ou Ã  rester en place ?" },
    {              text: "ÃŠtes-vous frÃ©quemment distrait ou ressentez-vous une agitation intÃ©rieure ou physique inhabituelle ?" },

    { section: 22, text: "Avez-vous Ã©tÃ© exposÃ© Ã  des situations de violence ou de maltraitance ? Si oui, souhaitez-vous en parler ?" },

    { section: 23, text: "Y a-t-il un sujet spÃ©cifique que vous souhaitez aborder lors de la consultation ?" },
    {              text: "Quels sont vos objectifs ou attentes en consultant actuellement ?" }
  ];

  // Indices de questions Ã  Ã©chelle (1â€“5) : marquage "scale"
  let notables = [5,6,7,8,9,10,11,12,13,14,15,16,17,19,20,21,22,23,25,27,28,31,33,34,35,36,38,41,42,43,44,45,47,48,49,50];
  notables.forEach(i => { if (questions[i]) questions[i].type = "scale"; });

  // Sections Ã  skip (si la 1re Q rÃ©pond "non" etc.)
  const sectionsAvecSkip = [5];


  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // MESSAGES dictionnaire 
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let messagesInterface = {
    "FranÃ§ais": {
      menuTitle:"SÃ©lectionner Questionnaire et Langue",
      labelQuestionnaire:"Questionnaire :",
      labelLangue:"Langue :",
      continuer:"Continuer",
      intro:"Ce questionnaire est anonyme et vous aide Ã  Ã©valuer votre bien-Ãªtre mental.",
      codeLabel:"Entrez maintenant un code de votre choix Ã  4 chiffres en le tapant sur le clavier",
      start:"Commencer",
      pause:"Pause", reprendre:"Reprendre",
      microOff:"ğŸ¤ Micro fermÃ©", microOn:"ğŸ¤ Micro actif",
      summaryTitle:"RÃ©sumÃ© et correction", codeLabelSummary:"Code questionnaire :",
      errorCode:"Veuillez entrer un code Ã  4 chiffres valide.",
      errorScale:"Entrez un chiffre de 1 Ã  5 : 1=jamais, 2=rarement, 3=parfois, 4=souvent, 5=trÃ¨s souvent",
      ttsOn:"Vocal", ttsOff:"Silence",
      btnPDF:"Exporter PDF", btnCopy:"Copier", btnClose:"Terminer",
      promptFilename:"Entrez un nom de fichier (.txt)",
      defaultFilename:"RÃ©ponses_Questionnaire_",
      valider:"Valider", corriger:"Corriger",
      alertOption:"Option non installÃ©e, reprenez la 1Ã¨re option",
      alertSaved:"Vos rÃ©ponses ont Ã©tÃ© enregistrÃ©es.",
      programme:"Programme",
      langue: "Langue",
      alertRewrite:"RÃ©Ã©crivez votre rÃ©ponse."
    },

    "English": {
      menuTitle:"Select Questionnaire and Language",
      labelQuestionnaire:"Questionnaire:", labelLangue:"Language:",
      continuer:"Continue", intro:"This questionnaire is anonymous.",
      codeLabel:"Enter your 4-digit code:", start:"Start",
      pause:"Pause", reprendre:"Resume",
      microOff:"ğŸ¤ Micro off", microOn:"ğŸ¤ Micro on",
      summaryTitle:"Summary and correction", codeLabelSummary:"Questionnaire code:",
      errorCode:"Please enter a valid 4-digit code.",
      errorScale:"After your answer, enter a number 1â€“5:1=never, 2=rarely, 3=sometimes, 4=often, 5=very often",
      ttsOn:"Voice", ttsOff:"Silence",
      btnPDF:"Export PDF", btnCopy:"Copy", btnClose:"Finish",
      promptFilename:"Enter a filename (.txt)",
      defaultFilename:"Questionnaire_Answers_",
      valider:"Validate", corriger:"Correct",
      alertOption:"Option not installed, please select the first option.",
      alertSaved:"Your responses have been saved.",
      programme:"Program",                
      language:"Language",                
      alertRewrite:"Rewrite your answer."
    },

    "Svenska": {
      menuTitle:"VÃ¤lj formulÃ¤r och sprÃ¥k",
      labelQuestionnaire:"FormulÃ¤r:", labelLangue:"SprÃ¥k:",
      continuer:"FortsÃ¤tt", intro:"Detta formulÃ¤r Ã¤r anonymt.",
      codeLabel:"Ange din fyrsiffriga kod:", start:"Starta",
      pause:"Paus", reprendre:"Ã…teruppta",
      microOff:"ğŸ¤ Mikrofon av", microOn:"ğŸ¤ Mikrofon pÃ¥",
      summaryTitle:"Sammanfattning och korrigering", codeLabelSummary:"FormulÃ¤rkod:",
      errorCode:"Ange en giltig fyrsiffrig kod.",
      errorScale:"Efter ditt svar, ange en siffra 1â€“4: 1=aldrig, 2=sÃ¤llan, 3=ibland, 4=ofta, 5=mycket ofta",
      ttsOn:"RÃ¶st", ttsOff:"Tyst",
      btnPDF:"Exportera PDF", btnCopy:"Kopiera", btnClose:"slut",
      promptFilename:"Ange ett filnamn (.txt)",
      defaultFilename:"FormulÃ¤r_Svar_",
      valider:"BekrÃ¤fta", corriger:"Korrigera",
      alertOption:"Alternativet Ã¤r inte installerat, vÃ¤lj det fÃ¶rsta alternativet.",
      alertSaved:"Dina svar har sparats.",
      programme:"Program",               
      language:"SprÃ¥k",                   
      alertRewrite:"Skriv om ditt svar."
    }
  };


  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Ã‰TAT GLOBAL
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let userCode = "", currentQuestion = 0;
  let answers = [];
  let paused = false, recognition = null, listening = false;
  let isValidating = false;
  let ttsEnabled = true;
  let currentLang = "FranÃ§ais";
  let justCorrected = false;
  const isMobile = /Android|iPhone|iPad|iPod|SamsungBrowser/i.test(navigator.userAgent);
  const mapChiffres = { "un":"1","une":"1","deux":"2","trois":"3","quatre":"4","one":"1","two":"2","three":"3","four":"4","ett":"1","tvÃ¥":"2","tva":"2","tre":"3","fyra":"4" };


  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // PRÃ‰PARATION DES SECTIONS / SKIP
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function preparerQuestions(arr, sectionsSkip){
    let courant = null;
    arr.forEach((q, idx) => {
      if (typeof q.section !== "undefined") courant = q.section;
      else if (courant !== null)          q.section = courant;
      else                                q.section = 0;

      if (sectionsSkip.includes(q.section)){
        if (idx === 0 || arr[idx-1].section !== q.section) q.skipIfNon = true;
      }
    });
  }
  preparerQuestions(questions, [5]);


  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // OUTILS UI
  function showNoSpeech(){
    const txt = (messagesInterface && messagesInterface[currentLang] && messagesInterface[currentLang].noSpeech) || "ğŸ¤ Pas de voix dÃ©tectÃ©e";
    const ms  = document.getElementById("microStatus");
    if (ms){ ms.textContent = txt; ms.style.color = "orange"; }
    const err = document.getElementById("mainErrorMsg") || document.getElementById("menuError");
    if (err) err.textContent = txt;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function jouerBipErreur(){
    try{
      const c=new (window.AudioContext||window.webkitAudioContext)();
      const o=c.createOscillator(); const g=c.createGain();
      o.type="sine"; o.frequency.value=440; g.gain.value=.1;
      o.connect(g); g.connect(c.destination);
      o.start(); o.stop(c.currentTime+.25);
    }catch(_){}
  }

  function updateProgress(){
    document.getElementById("progressBar").style.width = ((currentQuestion/questions.length)*100)+"%";
  }

  function updateTTSBtn(){
    const b = document.getElementById("ttsToggleBtn");
    if (b) b.textContent = ttsEnabled ? messagesInterface[currentLang].ttsOn : messagesInterface[currentLang].ttsOff;
  }

  function updateQuestionnaireLabels(){
    try{
      const sel=document.getElementById('questionnaireSelect'); if(!sel) return;
      const map = {
        'FranÃ§ais': { DSM:'DSM-5', Sommeil:'Sommeil', Psych:'Psych', Neurology:'Neurologie', MedGle:'Med Gle' },
        'English' : { DSM:'DSM-5', Sommeil:'Sleep',   Psych:'Psych', Neurology:'Neurology', MedGle:'GP' },
        'Svenska' : { DSM:'DSM-5', Sommeil:'SÃ¶mn',    Psych:'Psych', Neurology:'Neurologi', MedGle:'AllmÃ¤nt Med' }
      }[currentLang] || {};
      for (let i=0;i<sel.options.length;i++){
        const o=sel.options[i]; const v=(o.value||'').trim();
        if(map[v]) o.text = map[v] + (disabledForms.includes(v) ? " (" + messagesInterface[currentLang].unavailable + ")" : "");
      }
    }catch(_){}
  }


  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // AJOUT : mettre Ã  jour tous les libellÃ©s selon la langue
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function updateInterfaceLang() {
    const m = (messagesInterface && messagesInterface[currentLang]) || messagesInterface["FranÃ§ais"];

    // Accueil
    const h2 = document.querySelector('#menuScreen h2'); if (h2) h2.textContent = m.menuTitle;
    const labQ = document.querySelector('label[for="questionnaireSelect"]'); if (labQ) labQ.textContent = m.labelQuestionnaire;
    const labL = document.querySelector('label[for="langSelect"]'); if (labL) labL.textContent = m.labelLangue;
    const nextBtn = document.getElementById("nextLangBtn"); if (nextBtn) nextBtn.textContent = m.continuer;

    // Intro
    const lblCode = document.getElementById("labelCode"); if (lblCode) lblCode.textContent = m.codeLabel;
    const startBtn = document.getElementById("startBtn"); if (startBtn) startBtn.textContent = m.start;
    const introP = document.getElementById("introText"); if (introP && introP.textContent.trim()==="") introP.textContent = m.intro;

    // Main
    const validerBtn = document.getElementById("validerBtn"); if (validerBtn) validerBtn.textContent = m.valider;
    const corrigerBtn = document.getElementById("corrigerBtn"); if (corrigerBtn) corrigerBtn.textContent = m.corriger;
    const pauseBtn = document.getElementById("pauseBtn"); if (pauseBtn) pauseBtn.textContent = m.pause;

    // TTS + micro
    updateTTSBtn();
    const voiceBtn = document.getElementById("voiceBtn");
    if (voiceBtn) voiceBtn.textContent = (typeof listening!=="undefined" && listening) ? m.microOn : m.microOff;

    // Titre
    updateHeaderBar();
  
    // Boutons Programme / Langue (rÃ©sumÃ©)
    const btnProg = document.getElementById("btnProgramme");
    if (btnProg) btnProg.textContent = m.programme;

    const btnLangBtn = document.getElementById("btnLanguage");
    if (btnLangBtn) btnLangBtn.textContent = (m.language || m.langue || "Langue");
}


  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // TTS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function lireTexte(txt){
    if (!ttsEnabled) return;
    try{
      const u=new SpeechSynthesisUtterance(txt.replace(/<[^>]+>/g,""));
      u.lang=(currentLang==="English")?"en-US":(currentLang==="Svenska")?"sv-SE":"fr-FR";
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    }catch(_){}
  }


  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // RECONNAISSANCE VOCALE (HTTPS, pas dâ€™auto-start)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function setRecognitionLang(){
    if(!recognition) return;
    recognition.lang=(currentLang==="English")?"en-US":(currentLang==="Svenska")?"sv-SE":"fr-FR";
  }

  function initRecognition(){
    window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const ms = document.getElementById("microStatus");

    if(!window.SpeechRecognition){
      if(ms) ms.textContent = (currentLang==="English")?"ğŸ¤ Not supported":"ğŸ¤ Non supportÃ©";
      return;
    }
    if(!window.isSecureContext && location.hostname!=="localhost"){
      if(ms) ms.textContent=(currentLang==="English")?"ğŸ¤ HTTPS required":"ğŸ¤ HTTPS requis";
      return;
    }

    recognition = new window.SpeechRecognition();
    setRecognitionLang();
    recognition.continuous=true; recognition.interimResults=false;

    recognition.onstart = ()=>{
      listening=true;
      document.getElementById("microStatus").textContent=messagesInterface[currentLang].microOn;
      document.getElementById("voiceBtn").textContent=messagesInterface[currentLang].microOn;
      document.getElementById("microStatus").style.color="green";
    };
    recognition.onend   = ()=>{
      listening=false;
      document.getElementById("microStatus").textContent=messagesInterface[currentLang].microOff;
      document.getElementById("voiceBtn").textContent=messagesInterface[currentLang].microOff;
      document.getElementById("microStatus").style.color="red";
    };
    recognition.onerror = (e)=>{
      listening=false;
      const err = e && e.error;
      if (err === "no-speech"){
        showNoSpeech();
      } else {
        const ms = document.getElementById("microStatus");
        if (ms){
          let msg = "ğŸ¤ Erreur";
          if (err==="not-allowed"||err==="service-not-allowed") msg = messagesInterface[currentLang].permDenied || "ğŸ¤ Permission refusÃ©e (activez le micro)";
          else if (err==="audio-capture") msg = messagesInterface[currentLang].audioCapture || "ğŸ¤ Micro non dÃ©tectÃ©";
          else if (err==="no-speech")     msg = messagesInterface[currentLang].noSpeech || "ğŸ¤ Pas de voix dÃ©tectÃ©e";
          ms.textContent = msg;
        }
      }
      document.getElementById("voiceBtn").textContent=messagesInterface[currentLang].microOff;
    };
    recognition.onresult=(e)=>{
      try{
        let base = e.results[e.results.length-1];
        if (!base || !base[0] || !base[0].transcript){ showNoSpeech(); return; }
        let txt=String(base[0].transcript).toLowerCase().trim();
        txt=txt.replace(/\b(un|une|deux|trois|quatre|one|two|three|four|ett|tvÃ¥|tva|tre|fyra)\b/g,m=>mapChiffres[m]||m);
        if(txt.includes("stop")||txt.includes("slut")){
          txt=txt.replace(/stop|slut/gi,"").trim();
          document.getElementById("answerInput").value=txt;
          validateAnswer();
        }else{
          document.getElementById("answerInput").value=txt;
        }
      }catch(_){}
    };
  }

  /* (disabled by patch) original voiceBtn onclick was here */


  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // AFFICHAGE DE LA QUESTION COURANTE
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showQuestion(){
    if (recognition && listening){ try{ recognition.abort(); }catch(_){ recognition.stop(); } listening=false; }

    const q = questions[currentQuestion];
    document.getElementById("sectionNum").textContent = q.section ? "Section "+q.section : "";
    document.getElementById("questionNum").textContent = "Question "+(currentQuestion+1)+"/"+questions.length;
    document.getElementById("questionText").innerHTML = q.text;

    document.getElementById("mainErrorMsg").textContent = "";
    document.getElementById("scoreContainer").style.display="none";

    const f = document.getElementById("answerInput");
    f.value=""; setTimeout(()=>f.focus(),100);

    updateProgress();
    lireTexte(q.text);

    // Pas dâ€™auto-dÃ©marrage micro (Ã©vite re-prompts permission)
    // setTimeout(()=>{ if(recognition && !paused && !isMobile){ recognition.start(); listening=true; }},1200);
  }


  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // VALIDATION (attend correction + Ã©chelle + skip)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function validateAnswer(extraScore=null){
    if (paused){ isValidating=false; return; }

    { const _f=document.getElementById("answerInput"); const _r=((_f&&_f.value)||"").trim();
      if (justCorrected && (!_r && !extraScore)){ isValidating=false; return; } }

    if (isValidating) return; isValidating=true;
    if (typeof questions[currentQuestion]==="undefined"){ isValidating=false; return; }

    const f=document.getElementById("answerInput"); let r=(f.value||"").trim();
    if (justCorrected && (!r && !extraScore)){ isValidating=false; return; }
    justCorrected=false;

    if (!r && !extraScore){
      isValidating=false;
      document.getElementById("mainErrorMsg").textContent="âš ï¸ Veuillez Ã©crire une rÃ©ponse ou dicter STOP.";
      setTimeout(()=>document.getElementById("mainErrorMsg").textContent="",2000);
      return;
    }

    if (questions[currentQuestion].type==="scale"){
      const lowerResp=r.toLowerCase();

      // Skip section si 1re question et "non/no/nej"
      if (questions[currentQuestion].skipIfNon && (/(^|\b)(non|no|nej|n)(\b|$)/i).test(lowerResp)){
        answers[currentQuestion]=r||"(sans rÃ©ponse)";
        const sectionActuelle=questions[currentQuestion].section;
        let next=currentQuestion+1;
        while(next<questions.length && questions[next].section===sectionActuelle) next++;
        const tSkip=Math.max(config.tempsBaseReponse + r.length*config.tempsParCaractere, 3000);
        setTimeout(()=>{ if(justCorrected){ isValidating=false; return; } currentQuestion=next; isValidating=false; if(currentQuestion<questions.length) showQuestion(); else showSummary(); }, tSkip);
        return;
      }

      // "non" simple -> avancer
      if ((/(^|\b)(non|no|nej|n)(\b|$)/i).test(lowerResp)){
        answers[currentQuestion]=r||"(sans rÃ©ponse)";
        let t=Math.min(config.tempsBaseReponse + r.length*config.tempsParCaractere, config.tempsMaxReponse);
        t=Math.max(t,3000);
        setTimeout(()=>{ if(justCorrected){ isValidating=false; return; } currentQuestion++; isValidating=false; if(currentQuestion<questions.length) showQuestion(); else showSummary(); }, t);
        return;
      }

      // Demander score si absent
      let score=extraScore;
      if(!score){
        const sc=document.getElementById("scoreContainer"); sc.style.display="block";
        document.getElementById("scoreLabel").innerHTML='<span style="color:red;font-weight:bold;">'+messagesInterface[currentLang].errorScale+'</span>';
        document.getElementById("mainErrorMsg").textContent="";
        const scoreInput=document.getElementById("scoreInput");
        scoreInput.min="1"; scoreInput.max="4"; scoreInput.value="";
        setTimeout(()=>scoreInput.focus(),100);
        const handler=(e)=>{ if(e.key==="Enter"){ e.preventDefault(); document.getElementById("validateScoreBtn").click(); scoreInput.removeEventListener("keypress",handler);} };
        scoreInput.addEventListener("keypress",handler);
        if (recognition && listening){
          recognition.onresult=(e)=>{
            let txt=e.results[e.results.length-1][0].transcript.toLowerCase().trim();
            txt=txt.replace(/\b(un|une|deux|trois|quatre|one|two|three|four|ett|tvÃ¥|tva|tre|fyra)\b/g,m=>mapChiffres[m]||m);
            if(/stop|slut/.test(txt)){
              let chiffre=txt.replace(/stop|slut/gi,"").trim();
              if(chiffre && !isNaN(chiffre) && chiffre>=1 && chiffre<=4){ document.getElementById("scoreInput").value=chiffre; document.getElementById("validateScoreBtn").click(); }
            }
          };
        }
        const btn=document.getElementById("validateScoreBtn");
        btn.replaceWith(btn.cloneNode(true)); // reset listeners
        document.getElementById("validateScoreBtn").onclick=()=>{
          const entered=document.getElementById("scoreInput").value;
//     Erreur si notable <1 ou > 5
          if(!entered || isNaN(entered) || entered<1 || entered>5){
            jouerBipErreur();
            try{ document.getElementById("scoreInput").style.borderColor="red"; setTimeout(()=>{ document.getElementById("scoreInput").style.borderColor=""; },600);}catch(_){}
            return;
          }
          document.getElementById("scoreContainer").style.display="none";
          validateAnswer(entered);
        };
        isValidating=false; return;
      }

      r = r ? (r+" - "+score) : score;
    }

    answers[currentQuestion]=r||"(sans rÃ©ponse)";
    let t=Math.min(config.tempsBaseReponse + r.length*config.tempsParCaractere, config.tempsMaxReponse);
    t=Math.max(t,3000);
    setTimeout(()=>{ if(justCorrected){ isValidating=false; return; } currentQuestion++; isValidating=false; if(currentQuestion<questions.length) showQuestion(); else showSummary(); }, t);
  }


  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // BOUTONS (valider, corriger, pause, export)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById("validerBtn").onclick = validateAnswer;

  document.getElementById("answerInput").addEventListener("keydown", e=>{
    if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); validateAnswer(); }
  });

  document.getElementById("corrigerBtn").onclick = ()=>{
    const f=document.getElementById("answerInput"); f.value="";
    const sc=document.getElementById("scoreContainer"); if(sc){ sc.style.display="none"; document.getElementById("scoreInput").value=""; }
    if (recognition && listening){ try{ recognition.abort(); }catch(_){ recognition.stop(); } listening=false; }
    justCorrected=true; setTimeout(()=>f.focus(),100);
    const err=document.getElementById("mainErrorMsg"); err.textContent = (messagesInterface[currentLang] && messagesInterface[currentLang].alertRewrite) || "RÃ©Ã©crivez votre rÃ©ponse."; setTimeout(()=>err.textContent="",4000);
  };

  document.getElementById("pauseBtn").onclick = ()=>{
    if(!paused){
      localStorage.setItem("QSM_"+userCode, JSON.stringify({answers,currentQuestion}));
      document.getElementById("pauseBtn").textContent = messagesInterface[currentLang].reprendre;
      paused=true; if(recognition && listening){ try{ recognition.abort(); }catch(_){ recognition.stop(); } listening=false; }
    }else{
      paused=false; document.getElementById("pauseBtn").textContent = messagesInterface[currentLang].pause;
      const saved=localStorage.getItem("QSM_"+userCode);
      if(saved){ const d=JSON.parse(saved); answers=d.answers||[]; currentQuestion=d.currentQuestion||0; }
      showQuestion();
    }
  };

  function showSummary(){
    document.getElementById("main").style.display="none";
    document.getElementById("summary").style.display="block";
    document.getElementById("resumeCode").textContent=userCode;
    const ul=document.getElementById("answersList"); ul.innerHTML="";
    questions.forEach((q,i)=>{
      const li=document.createElement("li");
      li.innerHTML=`<b>${q.text}</b><br><textarea class='editable' onchange='answers[${i}]=this.value'>${answers[i]||''}</textarea>`;
      ul.appendChild(li);
    });
    lireTexte(messagesInterface[currentLang].summaryTitle);
  }

  document.getElementById("pdfBtn").onclick=()=>{
    let txt="Code: "+userCode+"\n";
    questions.forEach((q,i)=>{ txt+=`${i+1}. ${q.text}\nRÃ©ponse: ${answers[i]||''}\n\n`; });
    const w=window.open('','_blank'); if(w){ w.document.write('<pre>'+txt+'</pre>'); w.print(); }
  };

  document.getElementById("copyBtn").onclick=()=>{
    let txt="Code: "+userCode+"\n";
    questions.forEach((q,i)=>{ txt+=`${i+1}. ${q.text}: ${answers[i]||''}\n`; });
    const blob=new Blob([txt],{type:'text/plain'});
    const link=document.createElement('a'); link.href=URL.createObjectURL(blob); link.download="RÃ©ponses_Questionnaire_"+userCode+".txt"; link.click();
  };

  document.getElementById("closeBtn").onclick=()=>{
    const filename=prompt(messagesInterface[currentLang].promptFilename, messagesInterface[currentLang].defaultFilename+userCode+".txt");
    if(filename){
      let txt="Code: "+userCode+"\n";
      questions.forEach((q,i)=>{ txt+=`${i+1}. ${q.text}\nRÃ©ponse: ${answers[i]||''}\n\n`; });
      const blob=new Blob([txt],{type:'text/plain'});
      const link=document.createElement('a'); link.href=URL.createObjectURL(blob); link.download=filename; link.click();
      alert(messagesInterface[currentLang].alertSaved);
    }
  };


  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // NAVIGATION + INIT SÃ›RE
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function startQuestionnaire(){
    const selectedQ=document.getElementById("questionnaireSelect").value;
    if (Array.isArray(disabledForms) && disabledForms.includes(selectedQ)){
      document.getElementById("menuError").textContent = messagesInterface[currentLang].alertOption;
      try{ jouerBipErreur(); }catch(_){}
      alert(messagesInterface[currentLang].alertOption); return;
    }
    userCode=(document.getElementById("codeInput").value||"").trim();
    if (userCode.length!==4 || isNaN(userCode)){
      document.getElementById("introErrorMsg").textContent = messagesInterface[currentLang].errorCode;
      jouerBipErreur(); return;
    }
    answers=[]; currentQuestion=0; localStorage.removeItem("QSM_"+userCode);
    document.getElementById("introScreen").style.display="none";
    document.getElementById("main").style.display="block";
    showQuestion();
  }

  document.addEventListener("DOMContentLoaded", () => {
    // Titre
    updateHeaderBar();

    // Remplir QUESTIONNAIRES
    const qSel = document.getElementById("questionnaireSelect");
    if (qSel){
      qSel.innerHTML =
        '<option value="DSM">DSM-5</option>'+
        '<option value="Sommeil">Sommeil</option>'+
        '<option value="Psych">Psych</option>'+
        '<option value="Neurology">Neurologie</option>'+
        '<option value="MedGle">Med Gle</option>';
      for(let i=0;i<qSel.options.length;i++){ const o=qSel.options[i]; if(disabledForms.includes(o.value)){ o.text = o.text + " (" + messagesInterface[currentLang].unavailable + ")"; } }
      qSel.onchange = function(){
        const val=this.value;
        if(disabledForms.includes(val)){
          const el=document.getElementById("menuError"); if(el) el.textContent = messagesInterface[currentLang].alertOption;
          try{ jouerBipErreur(); }catch(_){}
        }else{
          const el=document.getElementById("menuError"); if(el) el.textContent="";
        }
      };
    }

    // Remplir LANGUES
    const lSel = document.getElementById("langSelect");
    if (lSel){
      lSel.innerHTML =
        '<option value="FranÃ§ais">FranÃ§ais</option>'+
        '<option value="English">English</option>'+
        '<option value="Svenska">Svenska</option>';
      currentLang = lSel.value || "FranÃ§ais";
      lSel.onchange = function(){
        currentLang=this.value;
        updateInterfaceLang();
        updateQuestionnaireLabels();
      };
    }

    // LibellÃ©s init
    updateInterfaceLang();
    updateQuestionnaireLabels();
    updateTTSBtn();

    // CONTINUER -> INTRO
    const nextBtn = document.getElementById("nextLangBtn");
    if (nextBtn){
      nextBtn.onclick = function(){
        const selectedQ = (qSel && qSel.value) || "DSM";
        if (disabledForms.includes(selectedQ)){
          const el=document.getElementById("menuError"); if(el) el.textContent = messagesInterface[currentLang].alertOption;
          try{ jouerBipErreur(); }catch(_){}
          alert(messagesInterface[currentLang].alertOption);
          return;
        }
        const label = qSel ? qSel.options[qSel.selectedIndex].text.replace(" (indisponible)","") : "DSM-5";
        APP.nom = "Questionnaire " + label;
        updateHeaderBar();

        const intro = (introByForm[currentLang] && introByForm[currentLang][selectedQ]) ? introByForm[currentLang][selectedQ] : messagesInterface[currentLang].intro;
        const introText = document.getElementById("introText"); if (introText) introText.textContent = intro; introText.style.whiteSpace="pre-line"; introText.style.lineHeight="1.9";
        document.getElementById("menuScreen").style.display="none";
        document.getElementById("introScreen").style.display="block";
        setTimeout(()=>document.getElementById("codeInput").focus(),100);
      };
    }

    // DÃ‰MARRER
    const startBtn = document.getElementById("startBtn");
    if (startBtn){
      startBtn.onclick = startQuestionnaire;
      document.getElementById("codeInput").addEventListener("keypress",e=>{ if(e.key==="Enter"){ e.preventDefault(); startQuestionnaire(); } });
    }
  });
  </script>


  <!-- ======================================================
       AJOUTS FINAUX â€“ TTS toggle + Micro sticky/auto-restart + Android/HTTPS
       ====================================================== -->
  <script>
  (function(){
    // Variables globales (sÃ©curisÃ©es si dÃ©jÃ  dÃ©finies)
    if (typeof window.recognition === "undefined") window.recognition = null;
    if (typeof window.listening   === "undefined") window.listening   = false;
    if (typeof window.currentLang === "undefined") window.currentLang = "FranÃ§ais";
    if (typeof window.ttsEnabled  === "undefined") window.ttsEnabled  = true;

    // Helper libellÃ©s (Ã©vite les crash si messagesInterface absent)
    function M(key, fallback){
      try { return (messagesInterface && messagesInterface[currentLang] && messagesInterface[currentLang][key]) || fallback; }
      catch(_){ return fallback; }
    }

    // === TTS toggle (Vocal/Silence) ===
    document.addEventListener("DOMContentLoaded", function(){
      var ttsBtn = document.getElementById("ttsToggleBtn");
      if (!ttsBtn) return;
      function updateTTSBtn(){ ttsBtn.textContent = ttsEnabled ? M('ttsOn','Vocal') : M('ttsOff','Silence'); }
      updateTTSBtn();
      ttsBtn.addEventListener("click", function(){
        ttsEnabled = !ttsEnabled;
        try { speechSynthesis.cancel(); } catch(_){}
        updateTTSBtn();
      });
    });

    // === Micro sticky / auto-restart ===
    var micSticky = false;
    var manuallyStopping = false;
    var restartTimer = null;

    // Lang reco
    if (typeof window.setRecognitionLang !== "function"){
      window.setRecognitionLang = function(){
        if(!recognition) return;
        recognition.lang = (currentLang==="English") ? "en-US"
                        : (currentLang==="Svenska") ? "sv-SE"
                        : "fr-FR";
      };
    }

    // Init/override reco (handlers robustes)
    window.initRecognition = function(){
      window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      var ms = document.getElementById("microStatus");

      if(!window.SpeechRecognition){
        if(ms) ms.textContent = (currentLang==="English") ? "ğŸ¤ Not supported on this device" : "ğŸ¤ Non supportÃ© sur cet appareil";
        return;
      }

      var isFile = location.protocol === "file:";
      if(!window.isSecureContext && location.hostname!=="localhost" && !isFile){
        if(ms) ms.textContent = (currentLang==="English") ? "ğŸ¤ HTTPS required" : "ğŸ¤ HTTPS requis";
        return;
      }

      recognition = new window.SpeechRecognition();
      setRecognitionLang();
      recognition.continuous = true;
      recognition.interimResults = false;

      recognition.onstart = function(){
        listening = true;
        var ms = document.getElementById("microStatus");
        if (ms){ ms.textContent = M('microOn','Micro ouvert'); ms.style.color = "green"; }
        var btn = document.getElementById("voiceBtn");
        if (btn) btn.textContent = M('microOn','Micro ouvert');
      };

      recognition.onend = function(){
        listening = false;
        var ms = document.getElementById("microStatus");
        if (ms){ ms.textContent = M('microOff','Micro fermÃ©'); ms.style.color = "red"; }
        var btn = document.getElementById("voiceBtn");
        if (btn) btn.textContent = M('microOff','Micro fermÃ©');

        if (micSticky && !manuallyStopping && !document.hidden){
          clearTimeout(restartTimer);
          restartTimer = setTimeout(function(){
            try{ recognition.start(); listening = true; if(btn) btn.textContent = M('microOn','Micro ouvert'); }catch(_){}
          }, 300);
        }
        manuallyStopping = false;
      };

      recognition.onerror = function(e){
        listening = false;
        var err = e && e.error;
        if (err !== "aborted"){
          var ms = document.getElementById("microStatus");
          if (ms){
            var msg = "ğŸ¤ Erreur";
            if (err==="not-allowed"||err==="service-not-allowed") msg = (currentLang==="English")?"ğŸ¤ Permission denied (allow mic)":"ğŸ¤ Permission refusÃ©e (activez le micro)";
            else if (err==="audio-capture") msg = (currentLang==="English")?"ğŸ¤ Microphone not found":"ğŸ¤ Micro non dÃ©tectÃ©";
            else if (err==="no-speech")     msg = (currentLang==="English")?"ğŸ¤ No speech detected":"ğŸ¤ Pas de voix dÃ©tectÃ©e";
            ms.textContent = msg;
          }
        }
        if (micSticky && !manuallyStopping && err!=="not-allowed" && err!=="service-not-allowed" && !document.hidden){
          clearTimeout(restartTimer);
          restartTimer = setTimeout(function(){
            try{ recognition.start(); listening = true; var btn=document.getElementById("voiceBtn"); if(btn) btn.textContent = M('microOn','Micro ouvert'); }catch(_){}
          }, 500);
        }
        manuallyStopping = false;
      };

      // onresult : on garde le tien si dÃ©jÃ  dÃ©fini ; sinon, on met une version neutre
      if (typeof recognition.onresult !== "function"){
        recognition.onresult = function(e){
          try{
            var r = e.results[e.results.length-1][0].transcript;
            var txt = (r||"").toLowerCase().trim();
            var a = document.getElementById("answerInput");
            if (a) a.value = txt;
          }catch(_){}
        };
      }
    };

    // Helpers dÃ©marrage/arrÃªt (gÃ¨rent sticky + UI + erreurs visibles)
    window.startMic = function(){
      if(!recognition) initRecognition();
      if(!recognition) return;
      try{ speechSynthesis.cancel(); }catch(_){}
      clearTimeout(restartTimer);
      setRecognitionLang();

      micSticky = true;
      var btn = document.getElementById("voiceBtn");
      var ms  = document.getElementById("microStatus");
      if (btn) btn.textContent = M('microOn','Micro ouvert');
      if (ms){ ms.textContent = M('microOn','Micro ouvert'); ms.style.color="green"; }

      try{
        recognition.start();
        listening = true;
      }catch(err){
        listening = false;
        micSticky = false;
        if (btn) btn.textContent = M('microOff','Micro fermÃ©');
        if (ms)  ms.textContent  = "ğŸ¤ Erreur start: " + ((err && (err.name||err.message)) || "inconnue");
      }
    };

    window.stopMic = function(opts){
      opts = opts || {};
      var manual = (typeof opts.manual==="boolean") ? opts.manual : true;
      if(!recognition) return;
      manuallyStopping = manual;
      if (manual) micSticky = false;
      clearTimeout(restartTimer);
      try{ recognition.abort(); }catch(_){ try{ recognition.stop(); }catch(_){ } }
      listening = false;
      var btn = document.getElementById("voiceBtn");
      var ms  = document.getElementById("microStatus");
      if (btn) btn.textContent = M('microOff','Micro fermÃ©');
      if (ms){ ms.textContent = M('microOff','Micro fermÃ©'); ms.style.color="red"; }
    };

    // Bouton MICRO (remplace les handlers existants si besoin)
    document.addEventListener("DOMContentLoaded", function(){
      var btn = document.getElementById("voiceBtn");
      var ms  = document.getElementById("microStatus");
      if (!btn) return;
      btn.onclick = function(){
        var isAndroid = /Android/i.test(navigator.userAgent);
        var isSecure  = window.isSecureContext || location.protocol === "https:" || location.hostname === "localhost";

        if (listening || micSticky){
          stopMic({manual:true});
          return;
        }
        if (isAndroid && !isSecure){
          if (ms) ms.textContent = "ğŸ¤ Android exige HTTPS pour le micro";
          return;
        }
        // prÃ©-permission uniquement Android
        if (isAndroid && navigator.mediaDevices && navigator.mediaDevices.getUserMedia){
          navigator.mediaDevices.getUserMedia({ audio:true })
            .then(function(s){ s.getTracks().forEach(function(t){t.stop();}); startMic(); })
            .catch(function(){ if (ms) ms.textContent = M('permDenied','ğŸ¤ Permission refusÃ©e (activez le micro)'); });
        } else {
          startMic();
        }
      };
    });

    // VisibilitÃ© onglet : stop temporaire / relance
    document.addEventListener("visibilitychange", function(){
      if (document.hidden && listening){
        stopMic({manual:false});
      } else if (!document.hidden && micSticky && !listening){
        startMic();
      }
    });
  })();
  </script>


<!-- === BEGIN: Unavailable label fix (handles (undefined)/language) === -->
<script>
(function(){
  function t(key, fallback){
    try { return (window.messagesInterface && window.messagesInterface[window.currentLang] && window.messagesInterface[window.currentLang][key]) ?? fallback ?? key; }
    catch(_){ return fallback ?? key; }
  }
  function normalizeLang(v){
    const s = String(v||'').toLowerCase();
    if (s.includes('english') || s === 'en') return 'English';
    if (s.includes('svensk') || s.includes('svenska') || s === 'sv') return 'Svenska';
    return 'FranÃ§ais';
  }
  function fixUnavailable(){
    const qsel = document.getElementById('questionnaireSelect');
    if (!qsel) return;
    const word = t('unavailable',
      (window.currentLang==='Svenska') ? 'otillgÃ¤nglig' :
      (window.currentLang==='English') ? 'unavailable'  :
      'indisponible'
    );
    Array.prototype.slice.call(qsel.options).forEach(o=>{
      if (!o || typeof o.text !== 'string') return;
      // replace any (undefined|indisponible|unavailable|otillgÃ¤nglig) at end
      o.text = o.text.replace(/\s*\((?:undefined|indisponible|unavailable|otillgÃ¤nglig)\)\s*$/i, ` (${word})`);
    });
  }
  // Hook language changes if present
  document.addEventListener('DOMContentLoaded', function(){
    const langSel = document.getElementById('langSelect');
    if (langSel){
      langSel.addEventListener('change', function(){
        window.currentLang = normalizeLang(langSel.value);
        try{ fixUnavailable(); }catch(_){}
      });
    }
    try{ fixUnavailable(); }catch(_){}
  });
  // Patch updateQuestionnaireLabels to always fix after it runs
  (function(){
    const orig = window.updateQuestionnaireLabels;
    window.updateQuestionnaireLabels = function(){
      if (typeof orig === 'function'){ try{ orig.apply(this, arguments); }catch(_){ } }
      try{ fixUnavailable(); }catch(_){}
    };
  })();
})();
</script>
<!-- === END: Unavailable label fix === -->


<script>
(function(){
  function renderHomeIntroMinimal(){
    var box = document.getElementById('headerIntro');
    if (!box) return;
    var L = window.currentLang || 'FranÃ§ais';
    var lines = {
      'FranÃ§ais':[
        "Choisissez un questionnaire et une langue pour commencer.",
        "Vos rÃ©ponses sont confidentielles. Prenez votre temps."
      ],
      'English':[
        "Pick a questionnaire and a language to get started.",
        "Your answers are confidential. Take your time."
      ],
      'Svenska':[
        "VÃ¤lj formulÃ¤r och sprÃ¥k fÃ¶r att bÃ¶rja.",
        "Dina svar Ã¤r konfidentiella. Ta den tid du behÃ¶ver."
      ]
    }[L] || ["Choisissez un questionnaire et une langue pour commencer."];
    box.innerHTML = lines.join('<br>');
    box.style.display = 'block';
  }
  document.addEventListener('DOMContentLoaded', function(){
    try{ renderHomeIntroMinimal(); }catch(e){}
  });
})();
</script>


<!-- HEADER d'accueil : lit la CONFIG + i18n + contrÃ´le langue dispo -->

  <!-- ========== CHARGEUR & NOTABLES ========== -->
  <script>
    function getQuestionsFor(formId, lang){
      var bank = window.QUESTIONNAIRE_BANK || {};
      var form = bank[formId] || {};
      if (form[lang] && form[lang].length) return form[lang].slice();
      if (form["FranÃ§ais"] && form["FranÃ§ais"].length) return form["FranÃ§ais"].slice();
      var langs = Object.keys(form);
      for (var i=0;i<langs.length;i++){
        var L = langs[i];
        if (Array.isArray(form[L]) && form[L].length) return form[L].slice();
      }
      return [];
    }

    // Liste dâ€™index notables par formulaire (adaptez Ã  vos tableaux)
    const NOTABLES_BY_FORM = {
      DSM:         [5,6,7,8,9,10],
      SOMMEIL:     [3,4,5,6],
      NEUROLOGIE:  [2,3,7],
      PSYCHIATRIE: [1,5,6],
      MEDEG:       [4,8]
    };

    function applyNotables(formId, questions){
      var list = (NOTABLES_BY_FORM && NOTABLES_BY_FORM[formId]) || [];
      for (var i=0;i<list.length;i++){
        var idx = list[i];
        if (questions[idx]) questions[idx].type = "scale";
      }
    }
  </script>
  <!-- ========== /CHARGEUR & NOTABLES ========== -->

<script id="homeHeader_i18n">
(function(){
  function setHomeHeaderTitle(){
    var title = document.getElementById('mainTitle');
    if (!title) return;
    var L = window.currentLang || 'FranÃ§ais';
    var map = (window.homeHeaderDefaultByLang && typeof window.homeHeaderDefaultByLang === 'object')
      ? window.homeHeaderDefaultByLang
      : { 'FranÃ§ais':'Questionnaire', 'English':'Questionnaire', 'Svenska':'FrÃ¥geformulÃ¤r' };
    title.textContent = map[L] || map['FranÃ§ais'];
  }

  function renderHomeIntro(){
    var box = document.getElementById('headerIntro');
    if (!box) return;
    var L = window.currentLang || 'FranÃ§ais';
    var map = (window.homeHeaderIntroLinesByLang && typeof window.homeHeaderIntroLinesByLang === 'object')
      ? window.homeHeaderIntroLinesByLang
      : {
          'FranÃ§ais':[
            'Choisissez un questionnaire et une langue pour commencer.',
            'Vos rÃ©ponses sont confidentielles. Prenez votre temps.'
          ],
          'English':[
            'Pick a questionnaire and a language to get started.',
            'Your answers are confidential. Take your time.'
          ],
          'Svenska':[
            'VÃ¤lj formulÃ¤r och sprÃ¥k fÃ¶r att bÃ¶rja.',
            'Dina svar Ã¤r konfidentiella. Ta den tid du behÃ¶ver.'
          ]
        };
    var lines = map[L] || map['FranÃ§ais'];
    box.innerHTML = (lines||[]).join('<br>');
    box.style.display = 'block';
  }

  function notAvailMessage(selLang, onlyLangs){
    var mi = (window.messagesInterface && messagesInterface[selLang]) || {};
    var prefix = mi.notAvailableLang
      || (selLang==='English' ? 'Not available in this language'
          : selLang==='Svenska' ? 'Inte tillgÃ¤ngligt pÃ¥ detta sprÃ¥k'
          : 'Non disponible dans cette langue');
    var onlyWord = mi.only
      || (selLang==='English' ? 'only' : selLang==='Svenska' ? 'endast' : 'seulement');
    var abbr = { 'FranÃ§ais':'Fr', 'Svenska':'Su', 'English':'Ang' };
    var ab = (onlyLangs||[]).map(function(L){ return abbr[L] || L; }).join('/');
    return prefix + ' â€” ' + onlyWord + ': ' + ab;
  }

  document.addEventListener('DOMContentLoaded', function(){
    var lSel = document.getElementById('langSelect');
    var qSel = document.getElementById('questionnaireSelect');
    var btn  = document.getElementById('nextLangBtn');
    var err  = document.getElementById('menuError');

    if (lSel && lSel.value) window.currentLang = lSel.value;

    setHomeHeaderTitle();
    renderHomeIntro();

    if (lSel){
      lSel.addEventListener('change', function(){
        window.currentLang = lSel.value || 'FranÃ§ais';
        setHomeHeaderTitle();
        renderHomeIntro();
      });
    }

    // disponibilitÃ© par questionnaire (utilise la CONFIG si fournie)
    window.availableLangsByForm = window.availableLangsByForm || { DSM:['FranÃ§ais'] };

    if (btn && qSel){
      var oldHandler = btn.onclick;
      btn.onclick = function(){
        var formId = (qSel.value||'').trim();
        var lang   = window.currentLang || (lSel && lSel.value) || 'FranÃ§ais';
        var okList = (window.availableLangsByForm && window.availableLangsByForm[formId]) || ['FranÃ§ais'];

        if (okList.indexOf(lang) === -1){
          if (err){ err.textContent = notAvailMessage(lang, okList); }
          try{ if (window.jouerBipErreur) jouerBipErreur(); }catch(_){}
          return;
        }
        try{ var hi=document.getElementById('headerIntro'); if(hi) hi.style.display='none'; }catch(_){}
        if (typeof oldHandler === 'function') return oldHandler.call(this);
      };
    }
  });
})();
</script>


<script>
document.addEventListener('DOMContentLoaded', function(){
  // APP.version override (optionnel)
  if (window.APP_VERSION_OVERRIDE && typeof window.APP_VERSION_OVERRIDE === 'string' && window.APP_VERSION_OVERRIDE.trim() !== ''){
    try{
      if (window.APP){ APP.version = window.APP_VERSION_OVERRIDE; }
      if (typeof updateHeaderBar === 'function'){ updateHeaderBar(); }
    }catch(_){}
  }

  // introByForm overrides (merge propriÃ©tÃ© Ã  propriÃ©tÃ©)
  try{
    if (window.introByFormOverrides && window.introByForm){
      Object.keys(window.introByFormOverrides).forEach(function(lang){
        if (!introByForm[lang]) introByForm[lang] = {};
        var src = window.introByFormOverrides[lang] || {};
        Object.keys(src).forEach(function(formId){
          introByForm[lang][formId] = src[formId];
        });
      });
    }
  }catch(_){}

  // messagesInterface overrides (merge)
  try{
    if (window.messagesInterfaceOverrides && window.messagesInterface){
      Object.keys(window.messagesInterfaceOverrides).forEach(function(lang){
        var src = window.messagesInterfaceOverrides[lang] || {};
        if (!messagesInterface[lang]) messagesInterface[lang] = {};
        Object.keys(src).forEach(function(k){
          messagesInterface[lang][k] = src[k];
        });
      });
    }
  }catch(_){}
});
</script>

</body>
</html>