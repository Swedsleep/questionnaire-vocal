<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Questionnaire DSM-5 (Vocal)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; background: #f9f9f9; }
    #main, #questionnaire, #summary { background: #fff; padding: 2em; border-radius: 1em; box-shadow: 0 2px 10px #0056cc22; max-width: 650px; margin: 3em auto 2em; }
    h1, h2 { color: #0056cc; font-weight: bold; }
    #status { color: #c00; font-weight: bold; margin-bottom: 1em; }
    #answersList { text-align: left; }
    input[type="text"] { padding: 0.5em; font-size: 1.1em; border-radius: 5px; border: 1px solid #bbb; margin: 0.7em 1em 0.7em 0; width: 7em; }
    button { background: #0056cc; color: #fff; border: none; border-radius: 1em; padding: 0.7em 1.7em; font-size: 1.1em; margin: 0.7em 0.7em 0 0; cursor: pointer; }
    button:disabled { background: #aaa; }
    #globalComment { width: 98%; min-height: 40px; font-size: 1.05em; padding: 0.5em; border-radius: 0.6em; border: 1px solid #bbb; margin-top: 0.7em; }
    #pauseBtn, #resumeBtn { background: #fb8c00; color: #fff; }
    @media (max-width: 700px) {
      #main, #questionnaire, #summary { padding: 0.7em; }
      button { padding: 0.5em 1em; font-size: 1em; }
    }
    .partTitle { font-size:1.22em; font-weight: bold; color:#337; margin-top:1.7em; }
  </style>
</head>
<body>
  <div id="main">
    <h1>Questionnaire DSM-5 (Vocal)</h1>
    <div id="status"></div>
    <div id="intro">
      <p id="introText"></p>
      <p>
        <label for="codeInput"><b>Entrez un code de 4 chiffres (au choix) :</b></label><br>
        <input type="text" id="codeInput" maxlength="4" pattern="[0-9]{4}" autocomplete="off" />
      </p>
      <button id="startBtn">Commencer</button>
    </div>
  </div>
  <div id="questionnaire" style="display:none;">
    <div id="partLabel" style="font-size:1.13em;color:#0056cc;margin-bottom:1em;"></div>
    <p id="question"></p>
    <button id="speakBtn">Répondre à voix haute</button>
    <p id="response"></p>
    <button id="nextBtn" style="display:none;">Question suivante</button>
    <button id="pauseBtn">Pause</button>
    <button id="resumeBtn" style="display:none;">Reprendre</button>
  </div>
  <div id="summary" style="display:none;">
    <h2>Merci !</h2>
    <p>Voici vos réponses :</p>
    <ul id="answersList"></ul>
    <label for="globalComment">Commentaire global (optionnel) :</label>
    <textarea id="globalComment" placeholder="Vous pouvez ici ajouter tout commentaire libre..."></textarea>
    <br>
    <button id="copyBtn">Copier les réponses</button>
    <button id="pdfBtn">Exporter en PDF</button>
    <p style="font-size:0.97em; color:#666; margin-top:2em;">Pour transmettre à votre professionnel, copiez vos réponses ou exportez en PDF puis envoyez-les par mail.</p>
  </div>
  <script>
    // --- Introduction ---
    const introTexte = "Je vais vous poser plusieurs questions portant sur les dernières semaines. Commencez par entrer un code de 4 chiffres que vous choisissez à votre guise. Ces questions sont groupées en 23 sections et réparties en deux parties : prenez votre temps, répondez calmement, vous pouvez aussi commenter. À tout moment, dites 'pause', 'reprendre' ou 'suivant' à voix haute, ou utilisez les boutons. À la fin, un commentaire global est possible. Vous pouvez passer à la question suivante en disant 'suivant' ou en appuyant sur Entrée.";

    // --- Titres des parties et découpe ---
    const partTitles = [
      "Première partie : Symptômes principaux",
      "Deuxième partie : Questions additionnelles"
    ];
    // La question 37 commence la 2e partie (ajuste selon tes sections si besoin)
    const partBreaks = [37];

    // --- QUESTIONS (~53, SECTIONS 1 À 23) ---
    // Partie 1 (exemple sections 1 à 15) :
    const questions = [
      { section: 1, text: "Avez-vous ressenti une tristesse ou une humeur dépressive ?" },
      { section: 2, text: "Avez-vous perdu de l'intérêt ou du plaisir pour la plupart des activités ?" },
      { section: 3, text: "Avez-vous eu des troubles du sommeil (insomnie ou hypersomnie) ?" },
      { section: 4, text: "Avez-vous ressenti de la fatigue ou un manque d'énergie ?" },
      { section: 5, text: "Avez-vous constaté des changements d'appétit ou de poids ?" },
      { section: 6, text: "Vous êtes-vous senti(e) inutile ou avec une faible estime de vous-même ?" },
      { section: 7, text: "Avez-vous eu des difficultés de concentration ou de prise de décision ?" },
      { section: 8, text: "Avez-vous eu des idées de mort ou de suicide ?" },
      { section: 9, text: "Avez-vous ressenti de l'anxiété ou une tension excessive ?" },
      { section: 10, text: "Avez-vous eu du mal à contrôler vos inquiétudes ?" },
      { section: 11, text: "Avez-vous eu des attaques de panique ?" },
      { section: 12, text: "Avez-vous eu peur dans des situations sociales ou de performance ?" },
      { section: 13, text: "Avez-vous évité certaines situations par peur ?" },
      { section: 14, text: "Avez-vous ressenti des peurs intenses, irrationnelles, pour certains objets ou situations ?" },
      { section: 15, text: "Avez-vous vécu un événement traumatisant ?" },
      { section: 16, text: "Avez-vous eu des cauchemars, des flashbacks ou évité certains souvenirs ?" },
      { section: 17, text: "Avez-vous eu des obsessions ou des compulsions répétitives ?" },
      { section: 18, text: "Avez-vous constaté une consommation excessive de substances (alcool, médicaments, drogues) ?" },
      { section: 19, text: "Avez-vous ressenti des envies irrépressibles de consommer une substance ?" },
      { section: 20, text: "Avez-vous eu des difficultés à contrôler votre consommation de substance ?" },
      { section: 21, text: "Avez-vous négligé vos obligations à cause d'une substance ?" },
      { section: 22, text: "Avez-vous continué la consommation malgré des problèmes liés ?" },
      { section: 23, text: "Avez-vous constaté une tolérance accrue ou des symptômes de sevrage ?" },
      { section: 24, text: "Avez-vous eu des périodes d’irritabilité, colère ou hostilité ?" },
      { section: 25, text: "Avez-vous été impliqué dans des disputes ou bagarres ?" },
      { section: 26, text: "Avez-vous endommagé des biens ou blessé des personnes ?" },
      { section: 27, text: "Avez-vous eu des difficultés à respecter des règles ou des lois ?" },
      { section: 28, text: "Avez-vous pris des risques inconsidérés ou des comportements impulsifs ?" },
      { section: 29, text: "Avez-vous eu des comportements sexuels à risque ?" },
      { section: 30, text: "Avez-vous eu des troubles de l’alimentation (restriction, vomissements, excès) ?" },
      { section: 31, text: "Avez-vous eu une image corporelle très négative ?" },
      { section: 32, text: "Avez-vous eu des troubles du comportement alimentaire en cachette ?" },
      { section: 33, text: "Avez-vous eu des crises de boulimie ou de grignotage incontrôlées ?" },
      { section: 34, text: "Avez-vous eu des difficultés à contrôler votre poids ?" },
      { section: 35, text: "Avez-vous utilisé des laxatifs, diurétiques ou fait du sport à l’excès pour contrôler votre poids ?" },
      { section: 36, text: "Avez-vous ressenti un sentiment de honte ou de culpabilité après avoir mangé ?" },
      { section: 37, text: "Avez-vous eu des troubles du contrôle des impulsions (achats, jeux, etc.) ?" },
      { section: 38, text: "Avez-vous eu des comportements obsessionnels ou des rituels répétitifs ?" },
      { section: 39, text: "Avez-vous constaté des changements importants de votre humeur (hauts et bas rapides) ?" },
      { section: 40, text: "Avez-vous eu des périodes d’euphorie ou d’excitation inhabituelle ?" },
      { section: 41, text: "Avez-vous eu des périodes d’activité physique ou verbale anormalement augmentée ?" },
      { section: 42, text: "Avez-vous eu des périodes où vous vous sentiez invincible ou avec une confiance excessive ?" },
      { section: 43, text: "Avez-vous eu des épisodes de repli, retrait social ou perte de contact avec vos proches ?" },
      { section: 44, text: "Avez-vous eu des pensées étranges, magiques ou des croyances inhabituelles ?" },
      { section: 45, text: "Avez-vous eu des hallucinations (voir, entendre, sentir des choses qui n’existent pas) ?" },
      { section: 46, text: "Avez-vous eu des difficultés à organiser vos pensées ou à suivre une conversation ?" },
      { section: 47, text: "Avez-vous eu des troubles de la mémoire récents ou anciens ?" },
      { section: 48, text: "Avez-vous eu des difficultés à accomplir des tâches du quotidien ?" },
      { section: 49, text: "Avez-vous remarqué des changements de personnalité ou de comportement inattendus ?" },
      { section: 50, text: "Avez-vous remarqué des tics, mouvements involontaires, ou des difficultés de coordination ?" },
      { section: 51, text: "Avez-vous eu des difficultés de parole, d’écriture, ou de compréhension du langage ?" },
      { section: 52, text: "Avez-vous constaté d’autres symptômes non cités ici, préoccupants pour vous ou votre entourage ?" },
      { section: 53, text: "Avez-vous, au cours des dernières semaines, bénéficié d’un soutien particulier (médical, psychologique, familial, social) ?" }
    ];
    // --- Variables ---
    let responses = [];
    let current = 0;
    let codePerso = "";
    let isPaused = false;

    // --- DOM Elements ---
    const mainDiv = document.getElementById("main");
    const introText = document.getElementById("introText");
    const codeInput = document.getElementById("codeInput");
    const startBtn = document.getElementById("startBtn");
    const questionnaireDiv = document.getElementById("questionnaire");
    const partLabel = document.getElementById("partLabel");
    const questionEl = document.getElementById("question");
    const speakBtn = document.getElementById("speakBtn");
    const responseEl = document.getElementById("response");
    const nextBtn = document.getElementById("nextBtn");
    const pauseBtn = document.getElementById("pauseBtn");
    const resumeBtn = document.getElementById("resumeBtn");
    const summaryDiv = document.getElementById("summary");
    const answersList = document.getElementById("answersList");
    const copyBtn = document.getElementById("copyBtn");
    const pdfBtn = document.getElementById("pdfBtn");
    const statusDiv = document.getElementById("status");
    const commentGlobal = document.getElementById("globalComment");

    introText.textContent = introTexte;

    function speak(txt) {
      if (!window.speechSynthesis) return;
      window.speechSynthesis.cancel();
      const utter = new SpeechSynthesisUtterance(txt);
      utter.lang = "fr-FR";
      window.speechSynthesis.speak(utter);
    }

    function askQuestion(idx) {
      // Afficher le titre de la partie selon le numéro de la question
    if (idx === 0) {
    partLabel.textContent = partTitles[0];
  } else if (partBreaks.includes(idx)) {
    partLabel.textContent = partTitles[1];
  }
  questionEl.textContent = "Section " + questions[idx].section + " : " + questions[idx].text;
  responseEl.textContent = "";
  nextBtn.style.display = "none";
  // Lecture à voix haute PUIS micro (reconnaissance vocale)
  const utter = new SpeechSynthesisUtterance(questions[idx].text);
  utter.lang = "fr-FR";
  utter.onend = function() {
    if (questionnaireDiv.style.display === "block" && !isPaused) {
      startRecognition();
    }
  };
  window.speechSynthesis.speak(utter);
}    
   
    function startRecognition() {
   if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    statusDiv.textContent = "Reconnaissance vocale non supportée sur ce navigateur ! (utilisez Chrome ou Edge)";
    return;
  }
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const recognition = new SpeechRecognition();
  recognition.lang = "fr-FR";
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;

  recognition.start();
  responseEl.textContent = "Écoute en cours...";
  recognition.onresult = function(event) {
    const transcript = event.results[0][0].transcript.trim().toLowerCase();
    responseEl.textContent = transcript;

    // Analyse si la personne veut juste passer
    if (
      transcript.includes("suivant") ||
      transcript.includes("question suivante") ||
      transcript.includes("passer") ||
      transcript === "" // silence = on saute
    ) {
      responses[current] = ""; // réponse vide = question sautée
    } else {
      responses[current] = transcript;
    }
    // Passage à la question suivante automatiquement
    setTimeout(() => {
      current++;
      if (current < questions.length) {
        askQuestion(current);
      } else {
        showSummary();
      }
    }, 700); // court délai pour lisibilité

  };
  recognition.onerror = function(event) {
    responseEl.textContent = "Erreur : " + event.error;
  };
} 

    startBtn.onclick = function() {
      const code = codeInput.value.trim();
      if (!/^\d{4}$/.test(code)) {
        statusDiv.textContent = "Merci de saisir un code de 4 chiffres.";
        return;
      }
      const utter = new SpeechSynthesisUtterance(introTexte);
      utter.lang = "fr-FR";
      utter.onend = function() {
        codePerso = code;
        mainDiv.style.display = "none";
        questionnaireDiv.style.display = "block";
        current = 0;
        responses = [];
        isPaused = false;
        resumeBtn.style.display = "none";
        pauseBtn.style.display = "inline";
        askQuestion(current);
      };
      window.speechSynthesis.speak(utter);
    };

    speakBtn.onclick = function() { if(!isPaused) startRecognition(); };
    nextBtn.onclick = function() {
      if (isPaused) return;
      current++;
      if (current < questions.length) {
        askQuestion(current);
      } else {
        showSummary();
      }
    };

    pauseBtn.onclick = function() {
      isPaused = true;
      questionnaireDiv.style.opacity = 0.3;
      pauseBtn.style.display = "none";
      resumeBtn.style.display = "inline";
      speak("Pause activée. Dites 'reprendre' pour continuer.");
    };
    resumeBtn.onclick = function() {
      isPaused = false;
      questionnaireDiv.style.opacity = 1;
      pauseBtn.style.display = "inline";
      resumeBtn.style.display = "none";
      speak("Reprise du questionnaire.");
    };

    document.addEventListener("keydown", function(e){
      if (questionnaireDiv.style.display === "block" && !isPaused && e.key === "Enter" && nextBtn.style.display !== "none") {
        nextBtn.click();
      }
    });

    function showSummary() {
      questionnaireDiv.style.display = "none";
      summaryDiv.style.display = "block";
      answersList.innerHTML = "";
      questions.forEach((q, i) => {
        const li = document.createElement("li");
        li.textContent = "Section " + q.section + " — " + q.text + " : " + (responses[i] || "");
        answersList.appendChild(li);
      });
    }

    copyBtn.onclick = function() {
      const txt = "Code : " + codePerso + "\n"
        + questions.map((q, i) => "Section " + q.section + " — " + q.text + " : " + (responses[i] || "")).join("\n")
        + "\nCommentaire global : " + commentGlobal.value;
      navigator.clipboard.writeText(txt);
      alert("Réponses copiées !");
    };

    pdfBtn.onclick = function() {
      window.print();
    };

  </script>
</body>
</html>
