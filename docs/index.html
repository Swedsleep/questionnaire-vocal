<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Questionnaire DSM-5 (Voix)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; background: #f9f9f9; }
    #main, #questionnaire, #summary { background: #fff; padding: 2em; border-radius: 1em; box-shadow: 0 2px 10px #0056cc22; max-width: 650px; margin: 3em auto 2em; }
    h1, h2 { color: #0056cc; font-weight: bold; }
    #status { color: #c00; font-weight: bold; margin-bottom: 1em; }
    #answersList { text-align: left; }
    input[type="text"] { padding: 0.5em; font-size: 1.1em; border-radius: 5px; border: 1px solid #bbb; margin: 0.7em 1em 0.7em 0; width: 7em; }
    button { background: #0056cc; color: #fff; border: none; border-radius: 1em; padding: 0.7em 1.7em; font-size: 1.1em; margin: 0.7em 0.7em 0 0; cursor: pointer; }
    button:disabled { background: #aaa; }
    #globalComment { width: 98%; min-height: 40px; font-size: 1.05em; padding: 0.5em; border-radius: 0.6em; border: 1px solid #bbb; margin-top: 0.7em; }
    #vocalTip {
      font-size:1.13em;
      margin:0.8em 0 1.2em 0;
      color:#b30000;
      background: #fff8c2;
      border-left: 6px solid #ff9900;
      padding: 0.6em 1em;
      font-weight: bold;
      display: block;
    }
  </style>
</head>
<body>
  <div id="main">
    <h1>Questionnaire DSM-5 (Voix)</h1>
    <div style="margin:1.5em 0">
      <button id="btnCommencer" style="font-size:1.22em;padding:0.9em 3em;">Commencer</button>
    </div>
    <div id="intro" style="display:none;">
      <div id="introText"></div>
      <p>
        <label for="codeInput"><b>Code √† 4 chiffres :</b></label><br>
        <input type="text" id="codeInput" maxlength="4" pattern="[0-9]{4}" autocomplete="off" />
      </p>
      <button id="startBtn">D√©marrer le questionnaire</button>
      <div id="status"></div>
    </div>
  </div>

  <div id="questionnaire" style="display:none;">
    <div id="partLabel" style="font-size:1.13em;color:#0056cc;margin-bottom:1em;"></div>
    <div id="vocalTip"></div>
    <p id="question"></p>
  </div>

  <div id="summary" style="display:none;">
    <h2>Merci !</h2>
    <p>Voici vos r√©ponses :</p>
    <ul id="answersList"></ul>
    <label for="globalComment">Commentaire global (facultatif) :</label>
    <textarea id="globalComment" placeholder="Vous pouvez ajouter un commentaire libre ici ..."></textarea>
    <br>
    <button id="copyBtn">Copier les r√©ponses</button>
    <button id="pdfBtn">Exporter en PDF</button>
  </div>

<script>
// ---------------------------------
// QUESTIONS √Ä MODIFIER ICI
// ---------------------------------
let questions = [
  { section: 1, text: "Quel √¢ge avez-vous ?" },
  { text: "Quel est votre sexe ?" },
  { text: "Quelle est votre profession ?" },
  { section: 2, text: "Y a-t-il des ant√©c√©dents m√©dicaux connus ? Si oui, veuillez pr√©ciser." },
  { text: "Prenez-vous des m√©dicaments actuellement ?" }
  // ... Ajoutez d'autres questions ici ...
];

let responses = [];
let current = 0, codePerso = "", autoNextTimeout = null, frenchVoice = null, consigneVocaleDejaLue = false;
let correctionResumeMode = false; // Pour correction depuis le r√©sum√©
let delaiRecoRelance = 5000; // (en ms) D√©lai entre deux relances micro

const mainDiv = document.getElementById("main");
const introText = document.getElementById("introText");
const codeInput = document.getElementById("codeInput");
const startBtn = document.getElementById("startBtn");
const questionnaireDiv = document.getElementById("questionnaire");
const partLabel = document.getElementById("partLabel");
const questionEl = document.getElementById("question");
const summaryDiv = document.getElementById("summary");
const answersList = document.getElementById("answersList");
const copyBtn = document.getElementById("copyBtn");
const pdfBtn = document.getElementById("pdfBtn");
const commentGlobal = document.getElementById("globalComment");
const vocalTip = document.getElementById("vocalTip");
const statusDiv = document.getElementById("status");

// --- Synth√®se vocale ---
window.speechSynthesis.onvoiceschanged = function() {
  const voices = window.speechSynthesis.getVoices();
  frenchVoice = voices.find(v => v.lang.startsWith("fr"));
};

function speak(txt, cb) {
  if (!window.speechSynthesis) return;
  window.speechSynthesis.cancel();
  const utter = new SpeechSynthesisUtterance(txt);
  utter.lang = "fr-FR";
  if (frenchVoice) utter.voice = frenchVoice;
  if (typeof cb === "function") utter.onend = cb;
  window.speechSynthesis.speak(utter);
}

function checkSpeechRecognitionSupport() {
  return ('webkitSpeechRecognition' in window) || ('SpeechRecognition' in window);
}

function startRecognition(callback) {
  if (!checkSpeechRecognitionSupport()) {
    callback(""); return;
  }
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const recognition = new SpeechRecognition();
  recognition.lang = "fr-FR";
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;
  recognition.start();
  recognition.onresult = function(event) {
    const transcript = event.results[0][0].transcript.trim();
    callback(transcript);
  };
  recognition.onerror = function(event) {
    callback("");
  };
}

// --- Affichage d'une question ---
function askQuestion(idx) {
	let transcriptAccumule = "";
  if (typeof questions[idx].section === "number") {
    partLabel.textContent = "Section " + questions[idx].section;
  } else {
    partLabel.textContent = "";
  }
  questionEl.innerHTML = questions[idx].text;

  // Conseils et instructions
  vocalTip.style.display = "block";
  vocalTip.innerHTML = '<b>Astuce :</b> <span style="color:#b30000">Terminez votre r√©ponse en disant "point" ou "valider".</span>';

  // Cr√©ation de la zone de r√©ponse (input + bouton micro + correction)
  let oldZone = document.getElementById("zoneResponse");
  if (oldZone) oldZone.remove();
  let responseZone = document.createElement("div");
  responseZone.id = "zoneResponse";
  responseZone.style.marginTop = "1.3em";
  let input = document.createElement("input");
  input.type = "text";
  input.id = "inputResponse";
  input.style.padding = "0.5em";
  input.style.width = "70%";
  input.placeholder = "R√©pondez ici ou utilisez le micro...";
  if (responses[idx]) input.value = responses[idx];
  responseZone.appendChild(input);

  // Bouton micro
  let btnVocal = document.createElement("button");
  btnVocal.type = "button";
  btnVocal.style.marginLeft = "1em";
  btnVocal.style.lineHeight = "1.3";
  btnVocal.style.display = "flex";
  btnVocal.style.flexDirection = "column";
  btnVocal.style.alignItems = "center";
  btnVocal.innerHTML =
    '<span>üé§ R√©ponse orale</span>' +
    '<span style="font-size:0.97em;color:#b30000;margin-top:2px;">Micro d√©sactiv√© ? Cliquez sur üé§</span>';
  responseZone.appendChild(btnVocal);

  let correctionZone = document.createElement("div");
  correctionZone.style.marginTop = "0.7em";
  responseZone.appendChild(correctionZone);

  questionEl.parentNode.appendChild(responseZone);
  input.focus();

  // Validation clavier (Entr√©e)
  input.addEventListener("keydown", function(e){
    if (e.key === "Enter") {
      responses[idx] = input.value.trim();
      correctionZone.innerHTML = "";
      setTimeout(function() {
        if (correctionResumeMode) {
          correctionResumeMode = false;
          showSummary();
        } else {
          nextQuestionOrSummary();
        }
      }, 2000);
    }
  });

  // Relance le micro au clic sur le bouton
  btnVocal.onclick = function() {
    correctionZone.innerHTML = "";
    autoRecognition(0);
  };

  // Lance la synth√®se vocale, PUIS la reconnaissance
  if (!consigneVocaleDejaLue) {
    consigneVocaleDejaLue = true;
    speak("Pour valider, terminez chaque r√©ponse en disant point ou valider.", function() {
      speak(questions[idx].text, function() {
        autoRecognition(0);
      });
    });
  } else {
    speak(questions[idx].text, function() {
      autoRecognition(0);
    });
  }

  // ---- Fonction locale de reconnaissance ----
  function autoRecognition(relanceCount = 0) {
    // ajuste le nombre de relances - en general 10 mais maintenant 20, peut √™tre plus !
    const maxRelances = 20; // si le micro s'arrete prematurement

    btnVocal.disabled = true;
    startRecognition(function(rep) {
      btnVocal.disabled = false;
      if (rep && rep.trim()) {
        // --- ACCUMULATION des fragments ---
        transcriptAccumule += " " + rep.trim();
        // Recherche mot-cl√© de fin (fran√ßais) UNIQUEMENT EN FIN DE REPONSE accumul√©e
        let endsWithMotCle = transcriptAccumule.match(/\b(point|valider|termin√©|fin)\b[\s.?!]*$/i);
        let cleanRep = transcriptAccumule.replace(/\b(point|valider|termin√©|fin)\b[\s.?!]*$/i, '').trim();

        // Si r√©ponse vide apr√®s mot-cl√©, on valide quand m√™me
        if (endsWithMotCle) {
          input.value = cleanRep;
          responses[idx] = cleanRep;
          correctionZone.innerHTML = "";
          // Cr√©e le bouton Corriger
          let btnRetry = document.createElement("button");
          btnRetry.textContent = "Corriger";
          btnRetry.style.background = "#fb8c00";
          correctionZone.appendChild(btnRetry);

          // Lance le timer pour passage automatique √† la question suivante
          let passageAuto = setTimeout(function() {
            transcriptAccumule = ""; 
            if (correctionResumeMode) {
              correctionResumeMode = false;
              showSummary();
            } else {
              nextQuestionOrSummary();
            }
          }, 2000);

          // Si on clique "Corriger", on annule le passage auto et on relance la reco
          btnRetry.onclick = function() {
            clearTimeout(passageAuto);
            input.value = "";
            transcriptAccumule = "";
            correctionZone.innerHTML = "";
            setTimeout(() => autoRecognition(0), 400);
          };
        }
        // sinon relance la reco
        else if (relanceCount < maxRelances) {
          input.value = transcriptAccumule + " ...";
          afficherZoneValiderOuAttente("En attente de la fin de votre r√©ponse (dites \"point\" ou \"valider\")...");
          setTimeout(() => autoRecognition(relanceCount + 1), delaiRecoRelance);
        // trop de relances, propose de valider, corriger manuellement
        } else {
          afficherZoneValiderOuAttente("Aucun mot de fin d√©tect√© apr√®s plusieurs tentatives. Vous pouvez valider ou recommencer.");
        }
      } else {
        // (reco n'entend rien du tout)
        if (relanceCount < maxRelances) {
          afficherZoneValiderOuAttente("Je n'ai rien entendu. R√©pondez √† nouveau ou validez si tout est correct.");
          setTimeout(() => autoRecognition(relanceCount + 1), delaiRecoRelance);
        } else {
          afficherZoneValiderOuAttente("Aucune r√©ponse d√©tect√©e apr√®s plusieurs tentatives. Vous pouvez valider ou r√©essayer.");
        }
      }
    });

    function afficherZoneValiderOuAttente(message) {
      correctionZone.innerHTML = `
        <button id="btnValiderManuel" style="background:#20b05a;">Valider</button>
        <button id="btnCorrigerReco" style="background:#fb8c00;margin-left:1em;">Corriger</button>
        <div style="margin-top:0.5em;color:#b30000;">${message}</div>
      `;
      document.getElementById("btnValiderManuel").onclick = function() {
        responses[idx] = input.value.trim();
        correctionZone.innerHTML = "";
        transcriptAccumule = "";
        setTimeout(function() {
          if (correctionResumeMode) {
            correctionResumeMode = false;
            showSummary();
          } else {
            nextQuestionOrSummary();
          }
        }, 2000);
      };
      document.getElementById("btnCorrigerReco").onclick = function() {
        input.value = "";
        transcriptAccumule = "";
        correctionZone.innerHTML = "";
        setTimeout(() => autoRecognition(0), 400);
      };
    }
  }
}

function nextQuestionOrSummary() {
  if (++current < questions.length) askQuestion(current);
  else showSummary();
}

function showSummary() {
  questionnaireDiv.style.display = "none";
  summaryDiv.style.display = "block";
  answersList.innerHTML = "";
  questions.forEach((q, i) => {
    const li = document.createElement("li");
    li.innerHTML = `<b>Section ${q.section || ""}</b> ‚Äî ${q.text} : <span id="rep${i}">${responses[i] ? responses[i] : "<em>(Aucune r√©ponse)</em>"}</span> `;
    let btnCorriger = document.createElement("button");
    btnCorriger.textContent = "Corriger";
    btnCorriger.style.marginLeft = "1em";
    btnCorriger.onclick = function() {
      summaryDiv.style.display = "none";
      questionnaireDiv.style.display = "block";
      current = i;
      correctionResumeMode = true;
      askQuestion(i);
    };
    li.appendChild(btnCorriger);
    answersList.appendChild(li);
  });
}

window.onload = function() {
  document.getElementById('btnCommencer').onclick = function() {
    document.getElementById('btnCommencer').style.display = 'none';
    // Affichage de l'intro avec innerHTML
    introText.innerHTML = `
      <p>Je vais vous poser quelques questions se rapportant √† ces derni√®res semaines.</p>
      <p>Les questions sont regroup√©es en sections.</p>
      <p>Parlez lentement et distinctement si vous utilisez le micro, mais terminez toujours en disant <b>point</b> ou <b>valider</b> quand vous avez fini. Vous pouvez aussi faire une pause ou ajouter un commentaire.</p>
      <p>Si votre ordinateur demande ‚Äúce site veut utiliser le micro‚Äù, r√©pondez <b>autoriser</b>.</p>
      <p>En cas d‚Äôerreur, vous pouvez utiliser le micro ou saisir votre r√©ponse au clavier.</p>
      <p>√Ä la fin, un commentaire global est possible et vous pourrez corriger, copier vos r√©ponses ou les enregistrer en PDF gr√¢ce aux boutons pr√©vus √† cet effet.</p>
      <p><b>Entrez maintenant un code √† 4 chiffres de votre choix en les tapant sur le clavier.</b></p>
    `;
    document.getElementById('intro').style.display = "block";
    setTimeout(function() {
      speak("Je vais vous poser quelques questions se rapportant √† ces derni√®res semaines. Les questions sont regroup√©es en sections. Parlez lentement et distinctement si vous utilisez le micro, mais terminez toujours en disant point ou valider quand vous avez fini. Vous pouvez aussi faire une pause ou ajouter un commentaire. Si votre ordinateur demande d'utiliser le micro, r√©pondez autoriser. En cas d‚Äôerreur, vous pouvez utiliser le micro ou saisir votre r√©ponse au clavier. √Ä la fin, un commentaire global est possible et vous pourrez corriger, copier vos r√©ponses ou les enregistrer en PDF gr√¢ce aux boutons pr√©vus √† cet effet. Entrez maintenant un code √† 4 chiffres de votre choix en les tapant sur le clavier.", function() {
        codeInput.focus();
      });
    }, 300);
  };
  startBtn.onclick = function() {
    const code = codeInput.value.trim();
    if (!/^\d{4}$/.test(code)) {
      statusDiv.textContent = "Veuillez entrer un code √† 4 chiffres.";
      return;
    }
    codePerso = code;
    mainDiv.style.display = "none";
    questionnaireDiv.style.display = "block";
    current = 0;
    responses = [];
    askQuestion(current);
  };
  // Permettre Entr√©e pour d√©marrer apr√®s le code
  codeInput.addEventListener("keydown", function(e) {
    if (e.key === "Enter") {
      startBtn.click();
    }
  });
  copyBtn.onclick = function() {
    const txt = "Code : " + codePerso + "\n"
      + questions.map((q, i) => "Section " + (q.section||"") + " ‚Äî " + q.text + " : " + (responses[i] || "(Aucune r√©ponse)")).join("\n")
      + "\nCommentaire global : " + commentGlobal.value;
    navigator.clipboard.writeText(txt);
    alert("R√©ponses copi√©es !");
  };
  pdfBtn.onclick = function() { window.print(); };
};
</script>
</body>
</html>
